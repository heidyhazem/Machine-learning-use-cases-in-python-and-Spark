{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "from pyspark import SparkContext\n",
    "from pyspark import SparkConf\n",
    "from pyspark.sql import SparkSession\n",
    "from pyspark.rdd import portable_hash\n",
    "from pyspark.statcounter import StatCounter\n",
    "from pyspark.sql.types import StringType,IntegerType,FloatType\n",
    "from pyspark.sql.functions import udf\n",
    "from pyspark.sql.functions import to_timestamp, current_timestamp, col,expr,unix_timestamp,round,when\n",
    "\n",
    "import os\n",
    "import json\n",
    "\n",
    "from datetime import datetime\n",
    "#pip install shapely\n",
    "from shapely.geometry import shape, Point\n",
    "from matplotlib import pyplot as plt\n",
    "spark = SparkSession.builder.appName(\"Taxi\")\\\n",
    "        .config(\"spark.driver.memory\", \"4g\")\\\n",
    "        .config(\"spark.driver.cores\", \"4\")\\\n",
    "        .getOrCreate()\n",
    "sc=spark.sparkContext"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [],
   "source": [
    "from  pprint import pprint\n",
    "def title(s):\n",
    "    pprint(\"---- %s -----\" %s)    \n",
    "    \n",
    "def see(s, v):\n",
    "    pprint(\"---- %s -----\" %s)\n",
    "    pprint(v)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Geospatial and Temporal Data Analysis on New York City Taxi Trip Data"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "- One statistic that is important to understanding the economics of taxis is utilization: the fraction of time that a cab is on the road and is occupied by one or more passen‐ gers. One factor that impacts utilization is the passenger’s destination: a cab that drops off passengers near Union Square at midday is much more likely to find its next fare in just a minute or two, whereas a cab that drops someone off at 2AM on Staten Island may have to drive all the way back to Manhattan before it finds its next fare.\n",
    "\n",
    "- <b>Our Goal</b>  : We’d like to quantify these effects and find out the average time it takes for a cab to find its next fare as a function of the borough in which it dropped its passengers off—Manhattan, Brooklyn, Queens, the Bronx, Staten Island, or none of the above (e.g., if it dropped the passenger off somewhere outside of the city, like Newark Inter‐ national Airport).\n",
    "\n",
    "- To carry out this analysis, we need to deal with two types of data that come up all the time: temporal data, such as dates and times, and geospatial information, like points of longitude and latitude and spatial boundaries."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Dataset\n",
    "- you can download the NYC taxi dataset from the link http://www.andresmh.com/nyctaxitrips/ then take a sample from it.\n",
    "- Or use directly the sampled versiod already made uploaded on canvas\n",
    "- Each row of the file after the header represents a single taxi ride in CSV format. For each ride, we have some attributes of the cab (a hashed version of the medallion num‐ ber) as well as the driver (a hashed version of the hack license, which is what licenses to drive taxis are called), some temporal information about when the trip started and ended, and the longitude/latitude coordinates for where the passenger(s) were picked up and dropped off."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>medallion</th>\n",
       "      <th>hack_license</th>\n",
       "      <th>vendor_id</th>\n",
       "      <th>rate_code</th>\n",
       "      <th>store_and_fwd_flag</th>\n",
       "      <th>pickup_datetime</th>\n",
       "      <th>dropoff_datetime</th>\n",
       "      <th>passenger_count</th>\n",
       "      <th>trip_time_in_secs</th>\n",
       "      <th>trip_distance</th>\n",
       "      <th>pickup_longitude</th>\n",
       "      <th>pickup_latitude</th>\n",
       "      <th>dropoff_longitude</th>\n",
       "      <th>dropoff_latitude</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>89D227B655E5C82AECF13C3F540D4CF4</td>\n",
       "      <td>BA96DE419E711691B9445D6A6307C170</td>\n",
       "      <td>CMT</td>\n",
       "      <td>1</td>\n",
       "      <td>N</td>\n",
       "      <td>2013-01-01 15:11:48</td>\n",
       "      <td>2013-01-01 15:18:10</td>\n",
       "      <td>4</td>\n",
       "      <td>382</td>\n",
       "      <td>1.00</td>\n",
       "      <td>-73.978165</td>\n",
       "      <td>40.757977</td>\n",
       "      <td>-73.989838</td>\n",
       "      <td>40.751171</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>0BD7C8F5BA12B88E0B67BED28BEA73D8</td>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>CMT</td>\n",
       "      <td>1</td>\n",
       "      <td>N</td>\n",
       "      <td>2013-01-06 00:18:35</td>\n",
       "      <td>2013-01-06 00:22:54</td>\n",
       "      <td>1</td>\n",
       "      <td>259</td>\n",
       "      <td>1.50</td>\n",
       "      <td>-74.006683</td>\n",
       "      <td>40.731781</td>\n",
       "      <td>-73.994499</td>\n",
       "      <td>40.75066</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>0BD7C8F5BA12B88E0B67BED28BEA73D8</td>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>CMT</td>\n",
       "      <td>1</td>\n",
       "      <td>N</td>\n",
       "      <td>2013-01-05 18:49:41</td>\n",
       "      <td>2013-01-05 18:54:23</td>\n",
       "      <td>1</td>\n",
       "      <td>282</td>\n",
       "      <td>1.10</td>\n",
       "      <td>-74.004707</td>\n",
       "      <td>40.73777</td>\n",
       "      <td>-74.009834</td>\n",
       "      <td>40.726002</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                          medallion                      hack_license  \\\n",
       "0  89D227B655E5C82AECF13C3F540D4CF4  BA96DE419E711691B9445D6A6307C170   \n",
       "1  0BD7C8F5BA12B88E0B67BED28BEA73D8  9FD8F69F0804BDB5549F40E9DA1BE472   \n",
       "2  0BD7C8F5BA12B88E0B67BED28BEA73D8  9FD8F69F0804BDB5549F40E9DA1BE472   \n",
       "\n",
       "  vendor_id rate_code store_and_fwd_flag      pickup_datetime  \\\n",
       "0       CMT         1                  N  2013-01-01 15:11:48   \n",
       "1       CMT         1                  N  2013-01-06 00:18:35   \n",
       "2       CMT         1                  N  2013-01-05 18:49:41   \n",
       "\n",
       "      dropoff_datetime passenger_count trip_time_in_secs trip_distance  \\\n",
       "0  2013-01-01 15:18:10               4               382          1.00   \n",
       "1  2013-01-06 00:22:54               1               259          1.50   \n",
       "2  2013-01-05 18:54:23               1               282          1.10   \n",
       "\n",
       "  pickup_longitude pickup_latitude dropoff_longitude dropoff_latitude  \n",
       "0       -73.978165       40.757977        -73.989838        40.751171  \n",
       "1       -74.006683       40.731781        -73.994499         40.75066  \n",
       "2       -74.004707        40.73777        -74.009834        40.726002  "
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#Let's Read the sampled dataset\n",
    "#Sample the Data\n",
    "df = spark.read.csv(\"ch08-geospatial/sample.csv\", header=True)\n",
    "df.limit(3).toPandas()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Preparing the New York City Taxi Trip Data\n",
    "- We are mainly intersted in each Trip's:\n",
    "    - Some Unique ID for the car (license)\n",
    "    - Pick-up location\n",
    "    - Pick-up time\n",
    "    - Drop-off location\n",
    "    - Drop-off time"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>hack_license</th>\n",
       "      <th>dropoff_longitude</th>\n",
       "      <th>dropoff_latitude</th>\n",
       "      <th>dropoff_datetime</th>\n",
       "      <th>pickup_longitude</th>\n",
       "      <th>pickup_latitude</th>\n",
       "      <th>pickup_datetime</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>BA96DE419E711691B9445D6A6307C170</td>\n",
       "      <td>-73.989838</td>\n",
       "      <td>40.751171</td>\n",
       "      <td>2013-01-01 15:18:10</td>\n",
       "      <td>-73.978165</td>\n",
       "      <td>40.757977</td>\n",
       "      <td>2013-01-01 15:11:48</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>-73.994499</td>\n",
       "      <td>40.75066</td>\n",
       "      <td>2013-01-06 00:22:54</td>\n",
       "      <td>-74.006683</td>\n",
       "      <td>40.731781</td>\n",
       "      <td>2013-01-06 00:18:35</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>-74.009834</td>\n",
       "      <td>40.726002</td>\n",
       "      <td>2013-01-05 18:54:23</td>\n",
       "      <td>-74.004707</td>\n",
       "      <td>40.73777</td>\n",
       "      <td>2013-01-05 18:49:41</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                       hack_license dropoff_longitude dropoff_latitude  \\\n",
       "0  BA96DE419E711691B9445D6A6307C170        -73.989838        40.751171   \n",
       "1  9FD8F69F0804BDB5549F40E9DA1BE472        -73.994499         40.75066   \n",
       "2  9FD8F69F0804BDB5549F40E9DA1BE472        -74.009834        40.726002   \n",
       "\n",
       "      dropoff_datetime pickup_longitude pickup_latitude      pickup_datetime  \n",
       "0  2013-01-01 15:18:10       -73.978165       40.757977  2013-01-01 15:11:48  \n",
       "1  2013-01-06 00:22:54       -74.006683       40.731781  2013-01-06 00:18:35  \n",
       "2  2013-01-05 18:54:23       -74.004707        40.73777  2013-01-05 18:49:41  "
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "taxi=df.select(\"hack_license\",\"dropoff_longitude\",\"dropoff_latitude\",\"dropoff_datetime\",\"pickup_longitude\",\"pickup_latitude\",\"pickup_datetime\")\n",
    "taxi.limit(3).toPandas()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Intro to GeoJSON\n",
    "The data we’ll use for the boundaries of boroughs in New York City comes written in a format called GeoJSON. The core object in GeoJSON is called a feature, which is made up of a geometry instance and a set of key-value pairs called properties. A geometry is a shape like a point, line, or polygon. A set of features is called a FeatureCollection. Let’s pull down the GeoJSON data for the NYC borough maps and take a look at its structure."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'---- features -----'\n",
      "{'geometry': {'coordinates': [[[-74.05050806403247, 40.566422034160816],\n",
      "                               [-74.04998352562575, 40.56639592492827],\n",
      "                               [-74.04931640362088, 40.56588774778044],\n",
      "                               [-74.04923629842045, 40.5653627363681],\n",
      "                               [-74.05002620158643, 40.565318180621134],\n",
      "                               [-74.05090601705089, 40.5660943421306],\n",
      "                               [-74.05067916748614, 40.5663108457364],\n",
      "                               [-74.05107159803778, 40.5667224933978],\n",
      "                               [-74.05050806403247, 40.566422034160816]]],\n",
      "              'type': 'Polygon'},\n",
      " 'id': 0,\n",
      " 'properties': {'@id': 'http://nyc.pediacities.com/Resource/Borough/Staten_Island',\n",
      "                'borough': 'Staten Island',\n",
      "                'boroughCode': 5},\n",
      " 'type': 'Feature'}\n"
     ]
    }
   ],
   "source": [
    "#Get a list of NY Zones\n",
    "with open('ch08-geospatial/nyc-boroughs.geojson', 'r') as f:\n",
    "        geo = json.load(f)\n",
    "features = geo['features']\n",
    "\n",
    "\n",
    "see(\"features\", features[0])"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Adding a shape feature"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [],
   "source": [
    "for f in features:\n",
    "    f[\"shape\"] = shape(f['geometry'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'type': 'Feature',\n",
       " 'id': 0,\n",
       " 'properties': {'boroughCode': 5,\n",
       "  'borough': 'Staten Island',\n",
       "  '@id': 'http://nyc.pediacities.com/Resource/Borough/Staten_Island'},\n",
       " 'geometry': {'type': 'Polygon',\n",
       "  'coordinates': [[[-74.05050806403247, 40.566422034160816],\n",
       "    [-74.04998352562575, 40.56639592492827],\n",
       "    [-74.04931640362088, 40.56588774778044],\n",
       "    [-74.04923629842045, 40.5653627363681],\n",
       "    [-74.05002620158643, 40.565318180621134],\n",
       "    [-74.05090601705089, 40.5660943421306],\n",
       "    [-74.05067916748614, 40.5663108457364],\n",
       "    [-74.05107159803778, 40.5667224933978],\n",
       "    [-74.05050806403247, 40.566422034160816]]]},\n",
       " 'shape': <shapely.geometry.polygon.Polygon at 0x7faea5e960f0>}"
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "features[0]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Sort zones by area and broadcast to executors"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'---- areaSortedFeatures -----'\n",
      "[{'geometry': {'coordinates': [[[-74.08221272914938, 40.64828016229008],\n",
      "                                [-74.08142228203805, 40.64850472594939],\n",
      "                                [-74.08072838762374, 40.64827487384626],\n",
      "                                [-74.07980996428705, 40.648383312987924],\n",
      "                                [-74.07899546333259, 40.648142554422414],\n",
      "                                [-74.0765065715286, 40.646968818183346],\n",
      "                                [-74.074452825637, 40.645067488723235],\n",
      "                                [-74.07395839976468, 40.645193205445516],\n",
      "                                [-74.07359107919278, 40.64499892804299],\n",
      "                                [-74.07349851367621, 40.6450833734751],\n",
      "                                [-74.07385653684726, 40.645424816099606],\n",
      "                                [-74.07333813856985, 40.64578311616224],\n",
      "                                [-74.07324539464854, 40.64570492526951],\n",
      "                                [-74.07369011806556, 40.64530572505997],\n",
      "                                [-74.07323853810762, 40.644963863909815],\n",
      "                                [-74.07302520507203, 40.64513123832014],\n",
      "                                [-74.07320225954699, 40.64494394124351],\n",
      "                                [-74.07305559881722, 40.644807917840915],\n",
      "                                [-74.07342590747642, 40.64500056851519],\n",
      "                                [-74.0731218418351, 40.644714799468936],\n",
      "                                [-74.07279850341497, 40.64491012376874],\n",
      "                                [-74.07258775553872, 40.64479086317363],\n",
      "                                [-74.07270308267604, 40.644645595627516],\n",
      "                                [-74.07256468232954, 40.64471974885815],\n",
      "                                [-74.07266630771205, 40.644620920659506],\n",
      "                                [-74.07253222025732, 40.64455679217023],\n",
      "                                [-74.07272467145081, 40.64462088376608],\n",
      "                                [-74.07269828799028, 40.644441273467336],\n",
      "                                [-74.07165829759785, 40.64503374643502],\n",
      "                                [-74.07230919046847, 40.644577754057316],\n",
      "                                [-74.0720184321324, 40.64441193294084],\n",
      "                                [-74.07229190281824, 40.64426604782041],\n",
      "                                [-74.07218488601669, 40.64411046539512],\n",
      "                                [-74.07186080870876, 40.64420176177014],\n",
      "                                [-74.07175648087782, 40.644011845498596],\n",
      "                                [-74.07205817506038, 40.64390042769861],\n",
      "                                [-74.07164969408521, 40.643786885724616],\n",
      "                                [-74.0715967920116, 40.64346015748862],\n",
      "                                [-74.07135612176634, 40.64349730455603],\n",
      "                                [-74.07148202432622, 40.64329262506351],\n",
      "                                [-74.07093784471478, 40.64334596384056],\n",
      "                                [-74.07144331706317, 40.643270561330596],\n",
      "                                [-74.07113105720937, 40.64320526367828],\n",
      "                                [-74.07150263147403, 40.64312930419288],\n",
      "                                [-74.07147777322618, 40.64280829377497],\n",
      "                                [-74.07164892198996, 40.64267993167963],\n",
      "                                [-74.0717035196727, 40.64279633527997],\n",
      "                                [-74.07218434969042, 40.64271409328908],\n",
      "                                [-74.07210952444633, 40.64246321679275],\n",
      "                                [-74.07037430990599, 40.64269140305315],\n",
      "                                [-74.07032923715391, 40.6425261281323],\n",
      "                                [-74.07323829183598, 40.64218473608235],\n",
      "                                [-74.07314400586033, 40.64185297448013],\n",
      "                                [-74.07024658698663, 40.64220697429687],\n",
      "                                [-74.0701939955922, 40.64200750280529],\n",
      "                                [-74.07308689819386, 40.6416368149696],\n",
      "                                [-74.07289005609631, 40.64092267287604],\n",
      "                                [-74.07001849148742, 40.6412781322375],\n",
      "                                [-74.06998354653953, 40.64106894311679],\n",
      "                                [-74.07285041194937, 40.64080368844502],\n",
      "                                [-74.07277690011112, 40.64052896314733],\n",
      "                                [-74.07307725837747, 40.64051331179631],\n",
      "                                [-74.07309035578785, 40.638618999685846],\n",
      "                                [-74.0729293338475, 40.63859264983823],\n",
      "                                [-74.07301444562263, 40.6384093846214],\n",
      "                                [-74.07237941129382, 40.638162726074086],\n",
      "                                [-74.0726063279755, 40.638136308347],\n",
      "                                [-74.07257275212609, 40.637871909875905],\n",
      "                                [-74.07348353801727, 40.63778735793559],\n",
      "                                [-74.07348737303563, 40.63723352923621],\n",
      "                                [-74.070539597052, 40.637471404624286],\n",
      "                                [-74.07049412213841, 40.63716188683957],\n",
      "                                [-74.07341562632818, 40.63689395096555],\n",
      "                                [-74.07337342888037, 40.6366107256394],\n",
      "                                [-74.07209483807512, 40.63664727762456],\n",
      "                                [-74.07335822045597, 40.636536094165145],\n",
      "                                [-74.07283184410434, 40.633666032825666],\n",
      "                                [-74.07332821316407, 40.63205844299033],\n",
      "                                [-74.07298474612325, 40.63030897898144],\n",
      "                                [-74.06802173543953, 40.62878758518545],\n",
      "                                [-74.06813019247993, 40.62853904609148],\n",
      "                                [-74.07291177936561, 40.629996379406485],\n",
      "                                [-74.07229223080012, 40.62715170770658],\n",
      "                                [-74.07278382204925, 40.62704855517877],\n",
      "                                [-74.07225500955774, 40.62460875019396],\n",
      "                                [-74.07106179396494, 40.62279315450542],\n",
      "                                [-74.07071994036926, 40.62257748182329],\n",
      "                                [-74.0697554308833, 40.62120813987237],\n",
      "                                [-74.06649335296385, 40.61889760159516],\n",
      "                                [-74.06596065271783, 40.619359015593716],\n",
      "                                [-74.066409889533, 40.61886446756707],\n",
      "                                [-74.06619907954871, 40.61872248128877],\n",
      "                                [-74.06557280841213, 40.61927454359993],\n",
      "                                [-74.06544586069484, 40.619202628289294],\n",
      "                                [-74.06668207982926, 40.61806749593851],\n",
      "                                [-74.0664155871518, 40.61787249816557],\n",
      "                                [-74.06604991535909, 40.61819541035272],\n",
      "                                [-74.06569864744144, 40.61795641558659],\n",
      "                                [-74.06546549952756, 40.61810707028078],\n",
      "                                [-74.06496189280531, 40.61777239957043],\n",
      "                                [-74.06435705158668, 40.6182459448656],\n",
      "                                [-74.06425721751593, 40.61817168758555],\n",
      "                                [-74.06509908407209, 40.61751095612546],\n",
      "                                [-74.06443662005027, 40.61706241460255],\n",
      "                                [-74.06401211702091, 40.61740222663604],\n",
      "                                [-74.06390892240366, 40.617328825149045],\n",
      "                                [-74.06432745858051, 40.616988503022164],\n",
      "                                [-74.06376129984488, 40.61679874999731],\n",
      "                                [-74.06376668678125, 40.616603630840274],\n",
      "                                [-74.06130709550273, 40.61419225076558],\n",
      "                                [-74.06033680792017, 40.61190188021965],\n",
      "                                [-74.05985444328627, 40.61210295860812],\n",
      "                                [-74.06001625116235, 40.6127636878954],\n",
      "                                [-74.06019772795604, 40.61278637593195],\n",
      "                                [-74.05999919711637, 40.61278389961864],\n",
      "                                [-74.05976930738184, 40.61205664713934],\n",
      "                                [-74.06027224809947, 40.6118196399392],\n",
      "                                [-74.05953306749004, 40.61171425506942],\n",
      "                                [-74.05927076216308, 40.61149313253697],\n",
      "                                [-74.05890133421525, 40.6110022864863],\n",
      "                                [-74.05912333939818, 40.61082228908909],\n",
      "                                [-74.05908584308706, 40.61063367725449],\n",
      "                                [-74.05716383878982, 40.60874278310366],\n",
      "                                [-74.0564956593677, 40.60724764825621],\n",
      "                                [-74.05552126122369, 40.60648289256866],\n",
      "                                [-74.05516001122324, 40.60673049135086],\n",
      "                                [-74.05498867839448, 40.60666069691176],\n",
      "                                [-74.05518218103558, 40.60647456683437],\n",
      "                                [-74.05505974095807, 40.60626542045283],\n",
      "                                [-74.05381069805443, 40.60591271885299],\n",
      "                                [-74.05360729740825, 40.60523880941774],\n",
      "                                [-74.05402039959057, 40.604934720916276],\n",
      "                                [-74.05353964480115, 40.603633557567214],\n",
      "                                [-74.05303330741086, 40.601466470699066],\n",
      "                                [-74.05338396754993, 40.60089521381436],\n",
      "                                [-74.05340705839461, 40.60052266104384],\n",
      "                                [-74.053007179793, 40.600160417609786],\n",
      "                                [-74.05222983028328, 40.59982388359394],\n",
      "                                [-74.0523249485185, 40.59971490532035],\n",
      "                                [-74.05291816194963, 40.599846257178136],\n",
      "                                [-74.05447422333907, 40.59875553954844],\n",
      "                                [-74.05719369904654, 40.59639507881197],\n",
      "                                [-74.05972690577234, 40.593908216712705],\n",
      "                                [-74.05964120596154, 40.593709388392966],\n",
      "                                [-74.05976660687645, 40.59383525751014],\n",
      "                                [-74.06055353637059, 40.593379755423555],\n",
      "                                [-74.06215274432547, 40.592025040541984],\n",
      "                                [-74.0650333235628, 40.58899099887046],\n",
      "                                [-74.0643600372125, 40.58826789117479],\n",
      "                                [-74.06477833032997, 40.588488310725666],\n",
      "                                [-74.06722276816991, 40.58673445026268],\n",
      "                                [-74.07096310182047, 40.58318199040259],\n",
      "                                [-74.0714918052123, 40.582168782652445],\n",
      "                                [-74.07065781537817, 40.58162562503772],\n",
      "                                [-74.07146670933011, 40.582027243898104],\n",
      "                                [-74.07177638431187, 40.581876535164],\n",
      "                                [-74.07499413073516, 40.57923655741631],\n",
      "                                [-74.07350591302192, 40.57840175175261],\n",
      "                                [-74.07332032496561, 40.57845733351104],\n",
      "                                [-74.07336118472105, 40.57827548828915],\n",
      "                                [-74.0735514665748, 40.57819839300049],\n",
      "                                [-74.07349669675465, 40.578327959714436],\n",
      "                                [-74.07508288192624, 40.57916015875556],\n",
      "                                [-74.07579819540715, 40.57830925065062],\n",
      "                                [-74.07523453617964, 40.577998803253166],\n",
      "                                [-74.07534622582406, 40.577887969571734],\n",
      "                                [-74.07601596977902, 40.57824491229024],\n",
      "                                [-74.0763992839852, 40.577994855052516],\n",
      "                                [-74.07629741018442, 40.577898625093354],\n",
      "                                [-74.07649283077298, 40.577960846125315],\n",
      "                                [-74.0768822647214, 40.5776367899115],\n",
      "                                [-74.07673747616744, 40.57737250932543],\n",
      "                                [-74.0769388152876, 40.577534345591324],\n",
      "                                [-74.07737472522547, 40.577282159408156],\n",
      "                                [-74.0792632125691, 40.57567129220569],\n",
      "                                [-74.07867933938917, 40.57508182522333],\n",
      "                                [-74.07933640538259, 40.575627204016875],\n",
      "                                [-74.0805028914751, 40.57498045871062],\n",
      "                                [-74.08595297385921, 40.57029822710423],\n",
      "                                [-74.08691263653225, 40.56898584268356],\n",
      "                                [-74.08621632224262, 40.5685326981471],\n",
      "                                [-74.08725078316108, 40.569081678192845],\n",
      "                                [-74.08835699781731, 40.56826670759138],\n",
      "                                [-74.08924906075137, 40.56701557053471],\n",
      "                                [-74.0899825993284, 40.567380011533096],\n",
      "                                [-74.09099905467043, 40.566737129097525],\n",
      "                                [-74.09404968409733, 40.562981647611046],\n",
      "                                [-74.0940707110943, 40.56273161946117],\n",
      "                                [-74.09511063361295, 40.56317327343458],\n",
      "                                [-74.09542371796329, 40.56315463556856],\n",
      "                                [-74.09567198061374, 40.56277559824538],\n",
      "                                [-74.0961184713546, 40.56258757449008],\n",
      "                                [-74.09661362272219, 40.56208714553736],\n",
      "                                [-74.09819767261925, 40.55983647680462],\n",
      "                                [-74.09829030823703, 40.559332614156816],\n",
      "                                [-74.0978212702401, 40.55905346621773],\n",
      "                                [-74.098764154809, 40.55942355165086],\n",
      "                                [-74.09938031432739, 40.55896419336116],\n",
      "                                [-74.09971784547339, 40.55914130003109],\n",
      "                                [-74.09992914201314, 40.55907068565248],\n",
      "                                [-74.10079963928112, 40.55832182111584],\n",
      "                                [-74.10124354139874, 40.557660831315516],\n",
      "                                [-74.10184637674706, 40.556216988779994],\n",
      "                                [-74.10184032964902, 40.555944639241226],\n",
      "                                [-74.10135423270512, 40.55558329994344],\n",
      "                                [-74.10265076360247, 40.55613440478521],\n",
      "                                [-74.1030983911154, 40.55590464145115],\n",
      "                                [-74.104659434914, 40.554120467311215],\n",
      "                                [-74.10508907947455, 40.55323546801067],\n",
      "                                [-74.1048444763634, 40.55302581455625],\n",
      "                                [-74.1064282206517, 40.55385337362125],\n",
      "                                [-74.10648150812321, 40.55415682837293],\n",
      "                                [-74.10734831283654, 40.55414815203113],\n",
      "                                [-74.10853922462545, 40.553258025673316],\n",
      "                                [-74.11028457387545, 40.55149635741753],\n",
      "                                [-74.11278846958068, 40.54788426322686],\n",
      "                                [-74.11301046104467, 40.547780065430075],\n",
      "                                [-74.11338340616278, 40.54807337515069],\n",
      "                                [-74.1147378116527, 40.54799661067657],\n",
      "                                [-74.1154617779842, 40.54751536252584],\n",
      "                                [-74.11608004748844, 40.547864946839056],\n",
      "                                [-74.11654532176986, 40.54787239314657],\n",
      "                                [-74.11729988946028, 40.54746402618905],\n",
      "                                [-74.11804133083713, 40.54730661289457],\n",
      "                                [-74.11977810044978, 40.54547045666162],\n",
      "                                [-74.12158070353603, 40.54520860391152],\n",
      "                                [-74.12245306050391, 40.54477054562982],\n",
      "                                [-74.12424449712779, 40.54311038091075],\n",
      "                                [-74.12575094543644, 40.5413054254503],\n",
      "                                [-74.13071184272673, 40.53453507543619],\n",
      "                                [-74.13356443498041, 40.53151117480558],\n",
      "                                [-74.1361884899335, 40.529620796687226],\n",
      "                                [-74.13690799076353, 40.52928191888262],\n",
      "                                [-74.1372850425187, 40.529740467984816],\n",
      "                                [-74.13825140719557, 40.529691336993864],\n",
      "                                [-74.13888337295604, 40.52996067648437],\n",
      "                                [-74.13915076013696, 40.53152011162197],\n",
      "                                [-74.14027015269595, 40.533300017195856],\n",
      "                                [-74.14061092703122, 40.534130600190146],\n",
      "                                [-74.14049228277466, 40.5349986680627],\n",
      "                                [-74.14000321007154, 40.53545691231956],\n",
      "                                [-74.13801169425402, 40.535203305981234],\n",
      "                                [-74.13507509325702, 40.535241170623024],\n",
      "                                [-74.13410017491098, 40.53549448910475],\n",
      "                                [-74.13302611571191, 40.536240336448444],\n",
      "                                [-74.13336905396335, 40.536356195225366],\n",
      "                                [-74.133012076688, 40.536256065042835],\n",
      "                                [-74.13316120141165, 40.53637400270101],\n",
      "                                [-74.13294266453624, 40.53632203308192],\n",
      "                                [-74.13119545689392, 40.53787240877454],\n",
      "                                [-74.13152564883185, 40.53771854263833],\n",
      "                                [-74.13129269799782, 40.53795670187078],\n",
      "                                [-74.13181387201776, 40.53830735868569],\n",
      "                                [-74.13211244495562, 40.53805229667768],\n",
      "                                [-74.13169767602074, 40.53785712331566],\n",
      "                                [-74.13184627147601, 40.5377346437995],\n",
      "                                [-74.13213560512459, 40.53803312718271],\n",
      "                                [-74.13242438513325, 40.53777496073492],\n",
      "                                [-74.13191182124633, 40.53753284097695],\n",
      "                                [-74.13207952279663, 40.537395034140346],\n",
      "                                [-74.13245302764169, 40.53776028136397],\n",
      "                                [-74.13275480490115, 40.537504536479915],\n",
      "                                [-74.13223596269246, 40.537262550736585],\n",
      "                                [-74.13239801584274, 40.537118864932644],\n",
      "                                [-74.13277603711707, 40.53748401091587],\n",
      "                                [-74.13307445571554, 40.537229123304016],\n",
      "                                [-74.13255786139075, 40.53699140775734],\n",
      "                                [-74.13273560233307, 40.53685453524317],\n",
      "                                [-74.13309457511573, 40.53721201792775],\n",
      "                                [-74.13339187377345, 40.536957984347545],\n",
      "                                [-74.13287438281006, 40.536719632302336],\n",
      "                                [-74.13303508839533, 40.536574875625874],\n",
      "                                [-74.1334100436537, 40.53693972187093],\n",
      "                                [-74.13386054140386, 40.53659796249382],\n",
      "                                [-74.12996934203086, 40.53996776961408],\n",
      "                                [-74.13020869361587, 40.53970266381724],\n",
      "                                [-74.12968375508697, 40.539471719592434],\n",
      "                                [-74.12984555503499, 40.53932685696156],\n",
      "                                [-74.13022754297855, 40.53968371755626],\n",
      "                                [-74.13052164283049, 40.53942555811962],\n",
      "                                [-74.13000272814955, 40.5391723936585],\n",
      "                                [-74.13016935798468, 40.539032878023356],\n",
      "                                [-74.13054176521166, 40.53940930625568],\n",
      "                                [-74.13083906851897, 40.539147592892455],\n",
      "                                [-74.13032244899303, 40.53890047124446],\n",
      "                                [-74.13048528360619, 40.538758916255226],\n",
      "                                [-74.13085918854105, 40.539131339802324],\n",
      "                                [-74.13115328715269, 40.53887357410363],\n",
      "                                [-74.13065428041834, 40.53861731113298],\n",
      "                                [-74.13079971896296, 40.5384924903141],\n",
      "                                [-74.13117436985073, 40.53885516139857],\n",
      "                                [-74.1314742421533, 40.53859831488273],\n",
      "                                [-74.13097509115993, 40.53834174990209],\n",
      "                                [-74.13111962282687, 40.53821889282776],\n",
      "                                [-74.13149740072583, 40.53858138137812],\n",
      "                                [-74.1317935081566, 40.53832599199171],\n",
      "                                [-74.13116466312682, 40.5379001358691],\n",
      "                                [-74.12798728527221, 40.540710977483094],\n",
      "                                [-74.12740612949632, 40.542018575486686],\n",
      "                                [-74.1276014602688, 40.54322278224507],\n",
      "                                [-74.12773143427357, 40.54342308480366],\n",
      "                                [-74.12792830507621, 40.54337324705591],\n",
      "                                [-74.12756660762844, 40.543499333934406],\n",
      "                                [-74.12762994038084, 40.54360889311556],\n",
      "                                [-74.12798968390742, 40.54348434363107],\n",
      "                                [-74.12781893446557, 40.543564399644545],\n",
      "                                [-74.12901864630726, 40.5450592417628],\n",
      "                                [-74.12987193425064, 40.54582820480734],\n",
      "                                [-74.13072654082104, 40.5462551903594],\n",
      "                                [-74.1332590565453, 40.5468472513372],\n",
      "                                [-74.1354231236101, 40.546574298494505],\n",
      "                                [-74.13641153119033, 40.54625235004184],\n",
      "                                [-74.13651613439379, 40.54591474813772],\n",
      "                                [-74.13713259013674, 40.54593097435956],\n",
      "                                [-74.13717987129871, 40.54579286466059],\n",
      "                                [-74.13626085280934, 40.54496329743595],\n",
      "                                [-74.1361154072406, 40.54501984567984],\n",
      "                                [-74.13638379801962, 40.54485467150626],\n",
      "                                [-74.13628433241063, 40.54494704058929],\n",
      "                                [-74.13719287519717, 40.54578429470004],\n",
      "                                [-74.13750833508854, 40.54557755723868],\n",
      "                                [-74.13673370161382, 40.544803742023824],\n",
      "                                [-74.1365890707106, 40.54484548609592],\n",
      "                                [-74.13687348630867, 40.54468259391001],\n",
      "                                [-74.13674888757028, 40.54478258448051],\n",
      "                                [-74.13794966050757, 40.54600033758064],\n",
      "                                [-74.13886951340419, 40.54513019760726],\n",
      "                                [-74.1376243074514, 40.54425356641827],\n",
      "                                [-74.13775620755672, 40.54414492877817],\n",
      "                                [-74.13767918310069, 40.54425862571798],\n",
      "                                [-74.13875534703462, 40.54493395842683],\n",
      "                                [-74.13901965079313, 40.54471556102991],\n",
      "                                [-74.13798990164425, 40.54399004378931],\n",
      "                                [-74.13786798524542, 40.544052544130935],\n",
      "                                [-74.13804346897912, 40.543904562966354],\n",
      "                                [-74.13903307178629, 40.54470491030004],\n",
      "                                [-74.13953937915747, 40.544295140872144],\n",
      "                                [-74.1394325300265, 40.54421721751615],\n",
      "                                [-74.13914541346338, 40.5445095811251],\n",
      "                                [-74.1390326599032, 40.54442809733309],\n",
      "                                [-74.13942069337884, 40.54420594353719],\n",
      "                                [-74.13928767295292, 40.544116589404595],\n",
      "                                [-74.13897454226766, 40.54437610181968],\n",
      "                                [-74.13922032859918, 40.54406670067381],\n",
      "                                [-74.13908266855016, 40.54396822488394],\n",
      "                                [-74.13887570388361, 40.54424355793482],\n",
      "                                [-74.13872812445962, 40.544130022535036],\n",
      "                                [-74.13907750658647, 40.543960153165635],\n",
      "                                [-74.13883460585724, 40.54379135939304],\n",
      "                                [-74.13858581159111, 40.54410463849028],\n",
      "                                [-74.13841535838715, 40.5439784273163],\n",
      "                                [-74.13882325461661, 40.54378405489584],\n",
      "                                [-74.13853996268433, 40.54358792869272],\n",
      "                                [-74.13820667267076, 40.54377367836004],\n",
      "                                [-74.13827964456065, 40.54386669457053],\n",
      "                                [-74.13815068621105, 40.543772036757126],\n",
      "                                [-74.13852649744582, 40.54357854230606],\n",
      "                                [-74.13834151288825, 40.54355182881402],\n",
      "                                [-74.13852282835352, 40.54340155175443],\n",
      "                                [-74.13845971967876, 40.543506285991505],\n",
      "                                [-74.13859005306276, 40.543450340366604],\n",
      "                                [-74.13853314542557, 40.54354436734085],\n",
      "                                [-74.1395697169857, 40.54427227483051],\n",
      "                                [-74.13983697786101, 40.54405246234081],\n",
      "                                [-74.13870632397281, 40.543291410834385],\n",
      "                                [-74.13890636539455, 40.543131777602305],\n",
      "                                [-74.1387714022684, 40.54329133220293],\n",
      "                                [-74.13903671922967, 40.54322699394062],\n",
      "                                [-74.13898355608605, 40.5433844113729],\n",
      "                                [-74.13967640480692, 40.54388899585862],\n",
      "                                [-74.13988897406261, 40.54375247188493],\n",
      "                                [-74.13970350694186, 40.54390877718623],\n",
      "                                [-74.13986527264346, 40.54402684400948],\n",
      "                                [-74.14001283835927, 40.54383042684478],\n",
      "                                [-74.14038573073624, 40.544033185007834],\n",
      "                                [-74.14032848694497, 40.54380208727108],\n",
      "                                [-74.1393499484191, 40.54309608509414],\n",
      "                                [-74.13921993485887, 40.543166085137855],\n",
      "                                [-74.13940810077601, 40.54301658508783],\n",
      "                                [-74.1402957194717, 40.543640457155504],\n",
      "                                [-74.14012638219606, 40.54351339341687],\n",
      "                                [-74.14028734539117, 40.54338507111912],\n",
      "                                [-74.13936132804034, 40.54282586399866],\n",
      "                                [-74.13953681548021, 40.542682150869766],\n",
      "                                [-74.13947877205683, 40.542768492577686],\n",
      "                                [-74.14030634258138, 40.54336711011437],\n",
      "                                [-74.14062715566956, 40.5431130296925],\n",
      "                                [-74.13975584890449, 40.54248115565518],\n",
      "                                [-74.13963169074168, 40.542541097566186],\n",
      "                                [-74.1398585989168, 40.54235717512914],\n",
      "                                [-74.13977484776696, 40.542464048803886],\n",
      "                                [-74.14064614869824, 40.543094214902105],\n",
      "                                [-74.14084520303844, 40.54293884497904],\n",
      "                                [-74.14132426794247, 40.5430941338302],\n",
      "                                [-74.14040685334778, 40.54236085545043],\n",
      "                                [-74.14016510037465, 40.54236621843349],\n",
      "                                [-74.14033528229753, 40.542228209259505],\n",
      "                                [-74.1402072360658, 40.54236522429834],\n",
      "                                [-74.14040656300696, 40.54232708255208],\n",
      "                                [-74.1414107356041, 40.54302241508036],\n",
      "                                [-74.14107892119063, 40.54279117185157],\n",
      "                                [-74.14108436804702, 40.542638913703854],\n",
      "                                [-74.14132653105818, 40.542747047487325],\n",
      "                                [-74.14114311299075, 40.54258765885135],\n",
      "                                [-74.14133547192979, 40.54258879247021],\n",
      "                                [-74.14026290400703, 40.541961511522594],\n",
      "                                [-74.14049581011315, 40.542060855323925],\n",
      "                                [-74.14067998093049, 40.54190859297103],\n",
      "                                [-74.1406191991196, 40.54205602164383],\n",
      "                                [-74.141349013796, 40.54257752313157],\n",
      "                                [-74.14146151585444, 40.54248390222388],\n",
      "                                [-74.14129442123696, 40.54233587588569],\n",
      "                                [-74.14148097474452, 40.542467709070465],\n",
      "                                [-74.14134854694552, 40.54229046487088],\n",
      "                                [-74.1415495790598, 40.542410617504544],\n",
      "                                [-74.14179719957053, 40.542200415382354],\n",
      "                                [-74.14089451090727, 40.54157111119269],\n",
      "                                [-74.14063984172135, 40.541694542037256],\n",
      "                                [-74.14095816832894, 40.54143207796497],\n",
      "                                [-74.14089477583407, 40.541537094860495],\n",
      "                                [-74.1418730797193, 40.542166658129396],\n",
      "                                [-74.14167226243086, 40.54233546409522],\n",
      "                                [-74.14229898630244, 40.54225211146237],\n",
      "                                [-74.14218344286682, 40.54201786105168],\n",
      "                                [-74.14247662235957, 40.541333709774804],\n",
      "                                [-74.14177661383262, 40.540088456334715],\n",
      "                                [-74.1420045928248, 40.53956795916434],\n",
      "                                [-74.141728926513, 40.53933948409703],\n",
      "                                [-74.14230351275853, 40.539069975289635],\n",
      "                                [-74.14233831577491, 40.53894919040834],\n",
      "                                [-74.14176587793769, 40.538542040999765],\n",
      "                                [-74.14226513008, 40.538140353664694],\n",
      "                                [-74.14183789388267, 40.53842162042676],\n",
      "                                [-74.1422299229487, 40.53811445387982],\n",
      "                                [-74.14207893644114, 40.53800396428509],\n",
      "                                [-74.14216718019146, 40.537932761068134],\n",
      "                                [-74.14121865335554, 40.537253998432476],\n",
      "                                [-74.14104157916553, 40.537346885467265],\n",
      "                                [-74.14129825471827, 40.53713817794835],\n",
      "                                [-74.14124113051592, 40.53723469173407],\n",
      "                                [-74.14218574841885, 40.537917778291465],\n",
      "                                [-74.14238963689816, 40.53775326100738],\n",
      "                                [-74.14158287690894, 40.537087577952384],\n",
      "                                [-74.14370120016167, 40.53721148265445],\n",
      "                                [-74.14418283372652, 40.53679403136108],\n",
      "                                [-74.14474069813583, 40.53580104421116],\n",
      "                                [-74.14536324652767, 40.535856356896446],\n",
      "                                [-74.14602008284771, 40.53555352822288],\n",
      "                                [-74.14599669615096, 40.53539039281184],\n",
      "                                [-74.14625512927718, 40.53553868473344],\n",
      "                                [-74.1470152518381, 40.53532447244462],\n",
      "                                [-74.14921733263971, 40.534241587760874],\n",
      "                                [-74.14977717489462, 40.53388786980671],\n",
      "                                [-74.14975846488888, 40.533424302751385],\n",
      "                                [-74.1506955361828, 40.53254583893709],\n",
      "                                [-74.15112025690527, 40.53274138250664],\n",
      "                                [-74.15175798831619, 40.532401794028026],\n",
      "                                [-74.15168241248844, 40.53227642276551],\n",
      "                                [-74.15185337744487, 40.532164021023306],\n",
      "                                [-74.15245660936691, 40.532067944000886],\n",
      "                                [-74.15413110791104, 40.53072291125635],\n",
      "                                [-74.1540474994981, 40.530594564841635],\n",
      "                                [-74.15421467768641, 40.530665367090286],\n",
      "                                [-74.15464111999903, 40.530334638424314],\n",
      "                                [-74.1545435737446, 40.53006213630361],\n",
      "                                [-74.15492894849402, 40.53022548357563],\n",
      "                                [-74.1556478233932, 40.52964298409564],\n",
      "                                [-74.15550357251261, 40.52943802633768],\n",
      "                                [-74.15573153435162, 40.529600905035],\n",
      "                                [-74.15599000320388, 40.52941960371783],\n",
      "                                [-74.15644868150137, 40.52893184220392],\n",
      "                                [-74.15618731852453, 40.528611371594224],\n",
      "                                [-74.15667105208165, 40.52899331160719],\n",
      "                                [-74.15701861946273, 40.52897765580955],\n",
      "                                [-74.15826103107302, 40.528300499162924],\n",
      "                                [-74.15797239457908, 40.52806708584439],\n",
      "                                [-74.1583264512699, 40.52827842678311],\n",
      "                                [-74.15970134520208, 40.52729599283153],\n",
      "                                [-74.16030426313961, 40.52755574782466],\n",
      "                                [-74.16158217423524, 40.527013477776684],\n",
      "                                [-74.1622719610889, 40.5271942628109],\n",
      "                                [-74.16372001594866, 40.526350032996014],\n",
      "                                [-74.16474657068612, 40.52608034550148],\n",
      "                                [-74.16884431820023, 40.5235906821566],\n",
      "                                [-74.16999711161473, 40.52304577245235],\n",
      "                                [-74.17048859810279, 40.52308417264987],\n",
      "                                [-74.1711026369617, 40.523549706673634],\n",
      "                                [-74.17206320175477, 40.523320569364714],\n",
      "                                [-74.17601245479074, 40.52087596282904],\n",
      "                                [-74.17758295522107, 40.519230866866],\n",
      "                                [-74.1783187669043, 40.519945785634874],\n",
      "                                [-74.17924381368915, 40.519984216674466],\n",
      "                                [-74.17939137556664, 40.52027827890804],\n",
      "                                [-74.1798101694893, 40.52055233770605],\n",
      "                                [-74.18104081208888, 40.52070503628713],\n",
      "                                [-74.18233555621089, 40.5203522380613],\n",
      "                                [-74.18314810962129, 40.51987083226618],\n",
      "                                [-74.18342370583407, 40.519889724568],\n",
      "                                [-74.18483116479761, 40.519341358600826],\n",
      "                                [-74.18656733191351, 40.51811585040488],\n",
      "                                [-74.18849353720908, 40.516340024595735],\n",
      "                                [-74.18926875557328, 40.51534497687235],\n",
      "                                [-74.1888429781565, 40.51508716631702],\n",
      "                                [-74.189712184984, 40.5153203785343],\n",
      "                                [-74.19178922683413, 40.51305164461371],\n",
      "                                [-74.19344318346748, 40.51156730959321],\n",
      "                                [-74.19409643736374, 40.51064124236222],\n",
      "                                [-74.19521339999075, 40.50997765295565],\n",
      "                                [-74.1964993698956, 40.50992353139784],\n",
      "                                [-74.19860831704769, 40.51119702314981],\n",
      "                                [-74.19967205357717, 40.51142685049747],\n",
      "                                [-74.20003712313155, 40.51267759982977],\n",
      "                                [-74.1989257279387, 40.51277730599838],\n",
      "                                [-74.19936127407833, 40.513010194432134],\n",
      "                                [-74.20082898254245, 40.51303070395842],\n",
      "                                [-74.20759701728616, 40.51183515615177],\n",
      "                                [-74.20861865689658, 40.511448235159534],\n",
      "                                [-74.20968789397442, 40.5107973693424],\n",
      "                                [-74.20918996825043, 40.51049905695518],\n",
      "                                [-74.20932200464202, 40.5103986288954],\n",
      "                                [-74.20971374205882, 40.51077770324296],\n",
      "                                [-74.20985338128547, 40.51067192532478],\n",
      "                                [-74.21051949643902, 40.509991368889615],\n",
      "                                [-74.21179183197997, 40.508173273494975],\n",
      "                                [-74.21338169973615, 40.50676628821535],\n",
      "                                [-74.21353130803672, 40.506397477227864],\n",
      "                                [-74.21385533847378, 40.50660702468343],\n",
      "                                [-74.21434250129724, 40.50651891128726],\n",
      "                                [-74.21510815859854, 40.50605975566713],\n",
      "                                [-74.21591242050036, 40.50537108838698],\n",
      "                                [-74.21758240164537, 40.50334139266352],\n",
      "                                [-74.21794570255729, 40.50336009019694],\n",
      "                                [-74.21977016417252, 40.502742688464764],\n",
      "                                [-74.22304657854353, 40.50247817905672],\n",
      "                                [-74.22500232195863, 40.50177029513201],\n",
      "                                [-74.22729413510994, 40.502297499455786],\n",
      "                                [-74.2297158423707, 40.50208568758763],\n",
      "                                [-74.23033892500187, 40.50180417837195],\n",
      "                                [-74.23055401780138, 40.50194685465974],\n",
      "                                [-74.23124443244187, 40.50182686031893],\n",
      "                                [-74.2335990411974, 40.50091253160123],\n",
      "                                [-74.23526495949426, 40.50060602857459],\n",
      "                                [-74.23678845619577, 40.500000835256294],\n",
      "                                [-74.23766770359758, 40.49912325493376],\n",
      "                                [-74.23798737378743, 40.49916598084095],\n",
      "                                [-74.23851321635706, 40.49889607636884],\n",
      "                                [-74.2398485124399, 40.49758301320698],\n",
      "                                [-74.24432798252599, 40.49754674021475],\n",
      "                                [-74.24548938982642, 40.49704477386727],\n",
      "                                [-74.24676102774195, 40.4961339876118],\n",
      "                                [-74.24802747419955, 40.49619003687116],\n",
      "                                [-74.2491715686896, 40.49656729705335],\n",
      "                                [-74.2508548942225, 40.49800616359516],\n",
      "                                [-74.25116773245712, 40.49899309065365],\n",
      "                                [-74.25259982739988, 40.49964307588627],\n",
      "                                [-74.25316124492012, 40.50012537646477],\n",
      "                                [-74.25384590619194, 40.50163566934948],\n",
      "                                [-74.25427407656721, 40.50216118050963],\n",
      "                                [-74.255309697652, 40.50413641072465],\n",
      "                                [-74.25530710377622, 40.506536454118994],\n",
      "                                [-74.25559136315215, 40.507712950729065],\n",
      "                                [-74.25524817753174, 40.508243230713],\n",
      "                                [-74.2546285670991, 40.50867482572702],\n",
      "                                [-74.25497290370966, 40.50880566213323],\n",
      "                                [-74.25461850728215, 40.50868390930244],\n",
      "                                [-74.25399753082532, 40.50897031496381],\n",
      "                                [-74.25403804567856, 40.509252671645676],\n",
      "                                [-74.25438877737022, 40.5093441841346],\n",
      "                                [-74.25431454169312, 40.50941369464896],\n",
      "                                [-74.2540206950534, 40.50927297578745],\n",
      "                                [-74.25368911881061, 40.50942559643912],\n",
      "                                [-74.25464651262912, 40.50982624592438],\n",
      "                                [-74.2545262173262, 40.50997301588613],\n",
      "                                [-74.25364812518256, 40.509470530436275],\n",
      "                                [-74.25331579805132, 40.50986150454094],\n",
      "                                [-74.25306394553088, 40.51105525736974],\n",
      "                                [-74.25325806885671, 40.51108868938079],\n",
      "                                [-74.25300847277556, 40.51119398970537],\n",
      "                                [-74.25352685076712, 40.51167776603184],\n",
      "                                [-74.25303635381556, 40.51143316045874],\n",
      "                                [-74.2530895087056, 40.51212196137829],\n",
      "                                [-74.25195197488476, 40.51299700254723],\n",
      "                                [-74.25212591397063, 40.51371037979996],\n",
      "                                [-74.25135331417925, 40.514392897589794],\n",
      "                                [-74.25054500497252, 40.51471683971554],\n",
      "                                [-74.25004587756582, 40.51510851049426],\n",
      "                                [-74.25055526413558, 40.515716342428846],\n",
      "                                [-74.25045509923827, 40.515772007109014],\n",
      "                                [-74.2501562651677, 40.515361188199435],\n",
      "                                [-74.24988824875, 40.51552154519294],\n",
      "                                [-74.25056007272198, 40.51610674153499],\n",
      "                                [-74.25041535921389, 40.516188335025866],\n",
      "                                [-74.24935660923902, 40.515005928193695],\n",
      "                                [-74.24933775243694, 40.51514081437933],\n",
      "                                [-74.24921528676103, 40.51508486129926],\n",
      "                                [-74.24963220109244, 40.515545377951014],\n",
      "                                [-74.24951393678681, 40.515693980976444],\n",
      "                                [-74.24994158808043, 40.51613748819098],\n",
      "                                [-74.24943096899092, 40.51568788559748],\n",
      "                                [-74.24864764632109, 40.516112628496785],\n",
      "                                [-74.24884323664612, 40.516305889562105],\n",
      "                                [-74.24854589291677, 40.516169917148424],\n",
      "                                [-74.24860080823053, 40.51631333191784],\n",
      "                                [-74.24828422083893, 40.51648694955367],\n",
      "                                [-74.24894624665615, 40.51719453978669],\n",
      "                                [-74.24940770789284, 40.516980831423666],\n",
      "                                [-74.24851449056038, 40.517475626265025],\n",
      "                                [-74.24891910653056, 40.51720843369244],\n",
      "                                [-74.24751811835533, 40.51573586477861],\n",
      "                                [-74.24693048008479, 40.516066454417754],\n",
      "                                [-74.24644039651325, 40.51596502850849],\n",
      "                                [-74.24612857679288, 40.51613739257371],\n",
      "                                [-74.24674997194067, 40.51649561324044],\n",
      "                                [-74.2465104026768, 40.51666985530595],\n",
      "                                [-74.24699556996596, 40.51718208519554],\n",
      "                                [-74.2464789970533, 40.516687327210796],\n",
      "                                [-74.24637736435444, 40.51673909335891],\n",
      "                                [-74.24653682834264, 40.51695996037946],\n",
      "                                [-74.24634969801772, 40.516753371934904],\n",
      "                                [-74.24520861528356, 40.51728974362411],\n",
      "                                [-74.24566989001386, 40.51778970805127],\n",
      "                                [-74.24563473169947, 40.51807558074574],\n",
      "                                [-74.24508804460541, 40.518066839404185],\n",
      "                                [-74.24429835217607, 40.51851500310773],\n",
      "                                [-74.24365228511601, 40.51829461462313],\n",
      "                                [-74.24232477833277, 40.51832652502175],\n",
      "                                [-74.24125968675216, 40.519180469822935],\n",
      "                                [-74.24103122918545, 40.5195425126879],\n",
      "                                [-74.24049069687705, 40.51919162897002],\n",
      "                                [-74.2398225831678, 40.520090711443764],\n",
      "                                [-74.24073284548761, 40.520569151653795],\n",
      "                                [-74.24117293552204, 40.52106013143197],\n",
      "                                [-74.24133219575525, 40.5208945175802],\n",
      "                                [-74.24293235036511, 40.52122716113277],\n",
      "                                [-74.2425837563945, 40.52219864900056],\n",
      "                                [-74.24276246783724, 40.522726789127525],\n",
      "                                [-74.24261397838436, 40.52308093752448],\n",
      "                                [-74.24280157009576, 40.524007296286655],\n",
      "                                [-74.24335792685866, 40.52481891382038],\n",
      "                                [-74.2439650075886, 40.52490536633781],\n",
      "                                [-74.24333883883857, 40.52585380517994],\n",
      "                                [-74.24282860818639, 40.52741888075681],\n",
      "                                [-74.24288671381211, 40.528200130826015],\n",
      "                                [-74.24251028997736, 40.5284459357685],\n",
      "                                [-74.24245541025243, 40.5289546995459],\n",
      "                                [-74.24218801762312, 40.529437551660216],\n",
      "                                [-74.24224528137324, 40.529822779504954],\n",
      "                                [-74.24150733322898, 40.53104134279515],\n",
      "                                [-74.24181061621535, 40.5325626754215],\n",
      "                                [-74.24217799663236, 40.532576138476585],\n",
      "                                [-74.24228200338158, 40.533387496517726],\n",
      "                                [-74.24196458870459, 40.53363371843316],\n",
      "                                [-74.2420457028601, 40.53434637705041],\n",
      "                                [-74.24236610201433, 40.53473423256333],\n",
      "                                [-74.24258024253025, 40.53476754110567],\n",
      "                                [-74.24285776172398, 40.53535344032169],\n",
      "                                [-74.24366348091216, 40.53607472027226],\n",
      "                                [-74.24412495988491, 40.53619629572898],\n",
      "                                [-74.24397655106576, 40.53646049855915],\n",
      "                                [-74.244147825387, 40.536881409917],\n",
      "                                [-74.24458753910726, 40.53693292707281],\n",
      "                                [-74.2449369311447, 40.53666387691711],\n",
      "                                [-74.2453365117606, 40.536905994434626],\n",
      "                                [-74.24526133913152, 40.537152213112975],\n",
      "                                [-74.24480069599332, 40.53740914543799],\n",
      "                                [-74.24444259671785, 40.53806676599294],\n",
      "                                [-74.24527100769262, 40.53924187018982],\n",
      "                                [-74.24560205698326, 40.540949594577306],\n",
      "                                [-74.24599284790563, 40.54127893215781],\n",
      "                                [-74.24648614815791, 40.54221339265561],\n",
      "                                [-74.24767778039612, 40.54312540330282],\n",
      "                                [-74.24803463735695, 40.5430932404414],\n",
      "                                [-74.2461842238389, 40.54563362585433],\n",
      "                                [-74.24336346552772, 40.54786513523582],\n",
      "                                [-74.24358447651356, 40.54762399087853],\n",
      "                                [-74.24293585929021, 40.54711321924521],\n",
      "                                [-74.24220318463439, 40.54694867830012],\n",
      "                                [-74.24039182810058, 40.54766331017373],\n",
      "                                [-74.23837191304233, 40.5491415668143],\n",
      "                                [-74.23761963467332, 40.550123468578576],\n",
      "                                [-74.23641623448971, 40.550508626843346],\n",
      "                                [-74.23617462444658, 40.551427061905144],\n",
      "                                [-74.23652110265434, 40.55202081602269],\n",
      "                                [-74.23641559733119, 40.55232806634521],\n",
      "                                [-74.23489865800809, 40.55300521667126],\n",
      "                                [-74.23377755011943, 40.552514200518864],\n",
      "                                [-74.23332400080325, 40.55250914356587],\n",
      "                                [-74.23229112933167, 40.553363697975676],\n",
      "                                [-74.23193331444945, 40.55414983011714],\n",
      "                                [-74.23071036198122, 40.55555759425892],\n",
      "                                [-74.23024952153514, 40.55538674616262],\n",
      "                                [-74.22931954185715, 40.55549158696272],\n",
      "                                [-74.22935253825547, 40.55575060062037],\n",
      "                                [-74.2290516218764, 40.556107082105065],\n",
      "                                [-74.22833214372008, 40.556390354311404],\n",
      "                                [-74.22743682730534, 40.55603853351641],\n",
      "                                [-74.22640494542952, 40.55625571284586],\n",
      "                                [-74.22390334134495, 40.55589706554448],\n",
      "                                [-74.22386421498088, 40.556097694082844],\n",
      "                                [-74.22344265106312, 40.55604656990351],\n",
      "                                [-74.22378606709131, 40.55588026800972],\n",
      "                                [-74.22316128942742, 40.55578714269176],\n",
      "                                [-74.22297219698757, 40.555503373621335],\n",
      "                                [-74.22257486801378, 40.555406209779626],\n",
      "                                [-74.22179863887052, 40.55541707075904],\n",
      "                                [-74.221570066132, 40.55564898295768],\n",
      "                                [-74.22129864604462, 40.55536622468556],\n",
      "                                [-74.22086715093403, 40.55594020227772],\n",
      "                                [-74.22055340151063, 40.555885284170316],\n",
      "                                [-74.22029711808953, 40.555597921062756],\n",
      "                                [-74.2201062716511, 40.55492881342833],\n",
      "                                [-74.21974356930724, 40.554612672072444],\n",
      "                                [-74.21908060899347, 40.554847002197945],\n",
      "                                [-74.21933701278986, 40.55569136698104],\n",
      "                                [-74.21921716370936, 40.55579696987859],\n",
      "                                [-74.21895832633393, 40.55485758391834],\n",
      "                                [-74.21859325782809, 40.55467421024775],\n",
      "                                [-74.21875036880562, 40.55602774053726],\n",
      "                                [-74.21817360193397, 40.555600523248486],\n",
      "                                [-74.21775342391739, 40.55500528477614],\n",
      "                                [-74.21604246060637, 40.55554411878299],\n",
      "                                [-74.21474053198821, 40.556242389132095],\n",
      "                                [-74.21499256964772, 40.55679493279591],\n",
      "                                [-74.21462340478288, 40.5569133622209],\n",
      "                                [-74.21422698854249, 40.556557317916976],\n",
      "                                [-74.21395537449885, 40.556657155299526],\n",
      "                                [-74.21376467317592, 40.556396943325296],\n",
      "                                [-74.21327457291385, 40.55662493427657],\n",
      "                                [-74.21314129720426, 40.55704350265861],\n",
      "                                [-74.21264343799234, 40.557289727559514],\n",
      "                                [-74.21267302665484, 40.55764756000804],\n",
      "                                [-74.21196767172766, 40.55844246877684],\n",
      "                                [-74.2117562045513, 40.559124757276166],\n",
      "                                [-74.21197029168816, 40.559297737576934],\n",
      "                                [-74.21188042321683, 40.55959693786178],\n",
      "                                [-74.21116899542135, 40.560486290873015],\n",
      "                                [-74.21134005281327, 40.56123035308527],\n",
      "                                [-74.21109600355392, 40.56213147179436],\n",
      "                                [-74.2113799785878, 40.56349220527484],\n",
      "                                [-74.2109627740123, 40.56429045015023],\n",
      "                                [-74.21062343743945, 40.56552020017451],\n",
      "                                [-74.209541258574, 40.567514584874445],\n",
      "                                [-74.2095346723291, 40.56792804865804],\n",
      "                                [-74.20932175268337, 40.568025300756894],\n",
      "                                [-74.20924168547245, 40.56840985887978],\n",
      "                                [-74.20886661112193, 40.568909793929144],\n",
      "                                [-74.20892636328671, 40.56962429844999],\n",
      "                                [-74.2080170538142, 40.57051795740074],\n",
      "                                [-74.20816851102191, 40.57071942341425],\n",
      "                                [-74.20783559015291, 40.57261000145161],\n",
      "                                [-74.2072629820731, 40.57411302777272],\n",
      "                                [-74.20707800410418, 40.574266340216596],\n",
      "                                [-74.20722650206055, 40.57448679641172],\n",
      "                                [-74.20707024366185, 40.574743025322306],\n",
      "                                [-74.20728431413177, 40.57525453287259],\n",
      "                                [-74.20681205626776, 40.5759220201882],\n",
      "                                [-74.20688655587765, 40.576217271059576],\n",
      "                                [-74.20708917179499, 40.57630559033878],\n",
      "                                [-74.20692739963452, 40.576543990351574],\n",
      "                                [-74.20658040532211, 40.57665273733928],\n",
      "                                [-74.2065312542969, 40.57690163736887],\n",
      "                                [-74.20680827961812, 40.57717956879255],\n",
      "                                [-74.20632344195357, 40.57753881896483],\n",
      "                                [-74.20591732509399, 40.57861664755362],\n",
      "                                [-74.20599255081493, 40.5804103839359],\n",
      "                                [-74.20572403289715, 40.58096568893214],\n",
      "                                [-74.20541737056936, 40.58106948648026],\n",
      "                                [-74.20508136987237, 40.58159946880263],\n",
      "                                [-74.20508854474978, 40.58220819107537],\n",
      "                                [-74.20470911902729, 40.58279766940681],\n",
      "                                [-74.2047390119264, 40.58317590192998],\n",
      "                                [-74.20440076433694, 40.583712945841945],\n",
      "                                [-74.20463390208106, 40.58432323880126],\n",
      "                                [-74.20436433899086, 40.58463414937066],\n",
      "                                [-74.2044147166378, 40.585523675327316],\n",
      "                                [-74.20411940258333, 40.58589554107575],\n",
      "                                [-74.20427494282602, 40.58611005412697],\n",
      "                                [-74.20426533002896, 40.58732053504293],\n",
      "                                [-74.204580656948, 40.588217603682615],\n",
      "                                [-74.20427270354554, 40.58848255532037],\n",
      "                                [-74.20412200974505, 40.58888147441248],\n",
      "                                [-74.20432302142395, 40.58913661747332],\n",
      "                                [-74.20457422073096, 40.58871913982805],\n",
      "                                [-74.2047052984863, 40.588772370830554],\n",
      "                                [-74.20443548401092, 40.589218398296886],\n",
      "                                [-74.20464608943212, 40.589285745465816],\n",
      "                                [-74.20440892551593, 40.58970676381156],\n",
      "                                [-74.20420300609163, 40.58964297174168],\n",
      "                                [-74.20385886609277, 40.59024952536163],\n",
      "                                [-74.20369974335803, 40.590199906474794],\n",
      "                                [-74.20388550456525, 40.58978611074145],\n",
      "                                [-74.20265866972035, 40.59072214628495],\n",
      "                                [-74.20237763634623, 40.59064471275514],\n",
      "                                [-74.20201405533597, 40.59089579962761],\n",
      "                                [-74.20246775956588, 40.59083882485734],\n",
      "                                [-74.20305254911504, 40.59114054180983],\n",
      "                                [-74.20296340195647, 40.591230922776646],\n",
      "                                [-74.20245495063138, 40.59095112585197],\n",
      "                                [-74.20202733920702, 40.590999079291976],\n",
      "                                [-74.20212378169599, 40.59125332695884],\n",
      "                                [-74.20184092914567, 40.59163648338191],\n",
      "                                [-74.2020034981303, 40.591780764795026],\n",
      "                                [-74.20231645768325, 40.59152396510271],\n",
      "                                [-74.2009254049636, 40.59286637930484],\n",
      "                                [-74.20047126824565, 40.59281175207507],\n",
      "                                [-74.19974060969571, 40.59356466924326],\n",
      "                                [-74.19936212279697, 40.594094082795515],\n",
      "                                [-74.19948344880581, 40.594320936292974],\n",
      "                                [-74.19873232553732, 40.59501179831049],\n",
      "                                [-74.19856137143589, 40.59555278101231],\n",
      "                                [-74.19795002851605, 40.59647035480368],\n",
      "                                [-74.19751357718712, 40.596798986036745],\n",
      "                                [-74.1974967092989, 40.5977242596034],\n",
      "                                [-74.1973061971382, 40.598059522240945],\n",
      "                                [-74.198759582053, 40.60171197517624],\n",
      "                                [-74.20014866759912, 40.60368335009869],\n",
      "                                [-74.20138527472525, 40.60463696620847],\n",
      "                                [-74.20221849851058, 40.605969679616486],\n",
      "                                [-74.20281628374595, 40.6082708279673],\n",
      "                                [-74.20230179014109, 40.61187564203902],\n",
      "                                [-74.20244374449527, 40.61328469393193],\n",
      "                                [-74.20038348428972, 40.61642809824377],\n",
      "                                [-74.20058986446028, 40.61702892738945],\n",
      "                                [-74.20082804386199, 40.61709428804824],\n",
      "                                [-74.20091423238284, 40.6177988223986],\n",
      "                                [-74.20087478740133, 40.61810041085587],\n",
      "                                [-74.2005415633182, 40.617997639493574],\n",
      "                                [-74.2003520385625, 40.618342198554714],\n",
      "                                [-74.20083991450642, 40.618804302607266],\n",
      "                                [-74.20068071414829, 40.61916845434691],\n",
      "                                [-74.20106997469387, 40.620381540777615],\n",
      "                                [-74.20050588129911, 40.620299672101225],\n",
      "                                [-74.2004280019192, 40.620495411016826],\n",
      "                                [-74.20087331582351, 40.62059115572628],\n",
      "                                [-74.2012584731012, 40.621554830872185],\n",
      "                                [-74.20143239998042, 40.62161260896532],\n",
      "                                [-74.20123089203487, 40.62207421098944],\n",
      "                                [-74.20127534263135, 40.62268827628605],\n",
      "                                [-74.2015455333477, 40.62269805202308],\n",
      "                                [-74.20163201104118, 40.62312156545739],\n",
      "                                [-74.20158494435564, 40.623498333681404],\n",
      "                                [-74.2013440890535, 40.62355256864429],\n",
      "                                [-74.20139733073574, 40.623736121038064],\n",
      "                                [-74.20107662790336, 40.62407834658977],\n",
      "                                [-74.20106080033605, 40.62589518001198],\n",
      "                                [-74.2011825235382, 40.626110215709424],\n",
      "                                [-74.20141670667913, 40.626070513895726],\n",
      "                                [-74.20098625565414, 40.62934414810631],\n",
      "                                [-74.20080479681283, 40.629332571444245],\n",
      "                                [-74.20075483895442, 40.629594634113445],\n",
      "                                [-74.20047681715859, 40.62965707750502],\n",
      "                                [-74.20042573785119, 40.62982116595333],\n",
      "                                [-74.20040812771619, 40.630250100694546],\n",
      "                                [-74.2007872998309, 40.630346274467826],\n",
      "                                [-74.20040311643062, 40.630292362267376],\n",
      "                                [-74.20018462159054, 40.631328669464196],\n",
      "                                [-74.20040380373983, 40.63144582069401],\n",
      "                                [-74.20017265407733, 40.631361080530986],\n",
      "                                [-74.1985008049662, 40.632797911275496],\n",
      "                                [-74.19834358263716, 40.63314148770742],\n",
      "                                [-74.19795938941567, 40.63326685738017],\n",
      "                                [-74.19759109214787, 40.63308128458118],\n",
      "                                [-74.19728675288839, 40.63329193108097],\n",
      "                                [-74.19714960710618, 40.63392851677317],\n",
      "                                [-74.19646965159137, 40.634135533685345],\n",
      "                                [-74.19602904691453, 40.634995848806994],\n",
      "                                [-74.19557688057971, 40.63500421857057],\n",
      "                                [-74.19530704356409, 40.63523389551714],\n",
      "                                [-74.19520096900101, 40.63570794464627],\n",
      "                                [-74.19442256854937, 40.636582106213126],\n",
      "                                [-74.19454212579784, 40.637070027627864],\n",
      "                                [-74.19478689682472, 40.637131511664194],\n",
      "                                [-74.19462310145194, 40.63739118356368],\n",
      "                                [-74.19397308627502, 40.63730911419635],\n",
      "                                [-74.19358317694856, 40.63746911688464],\n",
      "                                [-74.1937196462195, 40.63756681423009],\n",
      "                                [-74.186524968976, 40.64338866217144],\n",
      "                                [-74.18623209809664, 40.643187396855275],\n",
      "                                [-74.18590896667855, 40.643631439501746],\n",
      "                                [-74.18511431614886, 40.64380623828998],\n",
      "                                [-74.18524793597284, 40.643943526193326],\n",
      "                                [-74.18483594580849, 40.64412826633873],\n",
      "                                [-74.18442444966345, 40.643650691576006],\n",
      "                                [-74.18411319064437, 40.64353008362576],\n",
      "                                [-74.18406483232059, 40.64332399044576],\n",
      "                                [-74.18437046773805, 40.64309957688994],\n",
      "                                [-74.18421444000023, 40.64311689576949],\n",
      "                                [-74.18395490670643, 40.642494160701105],\n",
      "                                [-74.18365067064063, 40.64223964105066],\n",
      "                                [-74.18402611192016, 40.6431004085697],\n",
      "                                [-74.18384575936912, 40.64326615680737],\n",
      "                                [-74.18347427166458, 40.64294920957172],\n",
      "                                [-74.18324212279417, 40.64296367810302],\n",
      "                                [-74.18380044942424, 40.64443190122304],\n",
      "                                [-74.18366745872011, 40.644610485050045],\n",
      "                                [-74.18288931621835, 40.644800282946036],\n",
      "                                [-74.18118434243928, 40.644586159244874],\n",
      "                                [-74.18087212513224, 40.64485142967834],\n",
      "                                [-74.1804817395366, 40.64427892477648],\n",
      "                                [-74.18004077949232, 40.64428814067366],\n",
      "                                [-74.17990671455668, 40.64437872166942],\n",
      "                                [-74.17996507274023, 40.64526698230289],\n",
      "                                [-74.17988406361421, 40.645110240366485],\n",
      "                                [-74.17977452733297, 40.64516667984796],\n",
      "                                [-74.17972987752037, 40.6443807021119],\n",
      "                                [-74.17933117249433, 40.64440051177252],\n",
      "                                [-74.17925123340666, 40.64504187697026],\n",
      "                                [-74.17907466583897, 40.64464650705652],\n",
      "                                [-74.17903555928562, 40.643394787020675],\n",
      "                                [-74.17940482802034, 40.643128966476404],\n",
      "                                [-74.17958713721411, 40.64191768346404],\n",
      "                                [-74.17918728067565, 40.642987539996476],\n",
      "                                [-74.17879078436872, 40.64249850345952],\n",
      "                                [-74.17848313827356, 40.64252117573304],\n",
      "                                [-74.1782566214603, 40.64212922786819],\n",
      "                                [-74.17834127011963, 40.642589475995756],\n",
      "                                [-74.17781237608776, 40.6425998441421],\n",
      "                                [-74.17768636299844, 40.64294859651954],\n",
      "                                [-74.17721118570952, 40.64312277860307],\n",
      "                                [-74.17682386895902, 40.6428591459833],\n",
      "                                [-74.17670489151176, 40.64241691128398],\n",
      "                                [-74.17635786617535, 40.642327220562855],\n",
      "                                [-74.17668723791226, 40.64255213862118],\n",
      "                                [-74.17666795538247, 40.643386844771605],\n",
      "                                [-74.17598183191924, 40.643463622280734],\n",
      "                                [-74.1756025095443, 40.643311298672394],\n",
      "                                [-74.17547166255281, 40.644123105461105],\n",
      "                                [-74.17568470742579, 40.64471028489508],\n",
      "                                [-74.175466911572, 40.644646521102295],\n",
      "                                [-74.17529691545059, 40.64507507681892],\n",
      "                                [-74.17489620525136, 40.64514604796286],\n",
      "                                [-74.1745862147759, 40.645016932534716],\n",
      "                                [-74.17436572943609, 40.64513625864544],\n",
      "                                [-74.17294123891655, 40.64420452285585],\n",
      "                                [-74.17300154585654, 40.64358540507962],\n",
      "                                [-74.1724478448507, 40.64342157075081],\n",
      "                                [-74.1723616538658, 40.64325626755185],\n",
      "                                [-74.17272145305189, 40.642948498996596],\n",
      "                                [-74.17244027862147, 40.64281204816383],\n",
      "                                [-74.17196330565994, 40.642858132693306],\n",
      "                                [-74.1715081109973, 40.64313444209083],\n",
      "                                [-74.17133587281809, 40.64285576505196],\n",
      "                                [-74.1718604258258, 40.64252292851885],\n",
      "                                [-74.1717501278716, 40.642516756697326],\n",
      "                                [-74.17184927245124, 40.64238040270809],\n",
      "                                [-74.17172186950496, 40.64193954418145],\n",
      "                                [-74.17147878989452, 40.641702509993586],\n",
      "                                [-74.17158721923735, 40.64102959339448],\n",
      "                                [-74.17202315852481, 40.64098921566288],\n",
      "                                [-74.17297990582072, 40.64048606719564],\n",
      "                                [-74.172062005147, 40.640941613389465],\n",
      "                                [-74.17156994685425, 40.64101153209276],\n",
      "                                [-74.17138651859484, 40.64142273652407],\n",
      "                                [-74.17137382350512, 40.64208501526806],\n",
      "                                [-74.17105017239894, 40.64259381912996],\n",
      "                                [-74.1712752444561, 40.642111682767705],\n",
      "                                [-74.17119260951209, 40.64173962651395],\n",
      "                                [-74.1702863544111, 40.64177530825585],\n",
      "                                [-74.17007878651047, 40.64208616057546],\n",
      "                                [-74.16915295569139, 40.64187285987436],\n",
      "                                [-74.16906431628868, 40.64213001679856],\n",
      "                                [-74.1677409405136, 40.641727774498484],\n",
      "                                [-74.16757607092508, 40.64184479360803],\n",
      "                                [-74.16653375792838, 40.64142263788365],\n",
      "                                [-74.16621599917052, 40.64242410022791],\n",
      "                                [-74.16609989896035, 40.642406587001204],\n",
      "                                [-74.16631887292463, 40.64143667500493],\n",
      "                                [-74.16580110755903, 40.64122451144947],\n",
      "                                [-74.165634097638, 40.641214371375646],\n",
      "                                [-74.16544310082399, 40.64228054670855],\n",
      "                                [-74.16494139041184, 40.642208999889284],\n",
      "                                [-74.16519041758237, 40.64064230577937],\n",
      "                                [-74.16473426536808, 40.64039146702481],\n",
      "                                [-74.16457132366729, 40.64141866159588],\n",
      "                                [-74.16441459649116, 40.641396784726055],\n",
      "                                [-74.16459656597706, 40.64031574604756],\n",
      "                                [-74.16416886813633, 40.63999411023031],\n",
      "                                [-74.16400179001421, 40.64106586000679],\n",
      "                                [-74.16386249420358, 40.64105279734379],\n",
      "                                [-74.16404731516644, 40.63994665879952],\n",
      "                                [-74.16384976588611, 40.63989150971772],\n",
      "                                [-74.16345445682002, 40.63985656039824],\n",
      "                                [-74.16324577932507, 40.64095741918557],\n",
      "                                [-74.16280502789435, 40.641038187922256],\n",
      "                                [-74.16167534694236, 40.640610784766764],\n",
      "                                [-74.16228465252085, 40.63876565277231],\n",
      "                                [-74.16181856612259, 40.638646278777614],\n",
      "                                [-74.16144917826772, 40.639428336668296],\n",
      "                                [-74.16130221801549, 40.639393734457016],\n",
      "                                [-74.16166010706995, 40.63866499331326],\n",
      "                                [-74.16124015815107, 40.63859501161616],\n",
      "                                [-74.16090490770394, 40.63938614081601],\n",
      "                                [-74.16073654872478, 40.63935101447544],\n",
      "                                [-74.16108161758908, 40.63856776831252],\n",
      "                                [-74.16081126840743, 40.63863295888882],\n",
      "                                [-74.16034819993168, 40.638443726453474],\n",
      "                                [-74.15986410465042, 40.63992782369277],\n",
      "                                [-74.16022466453101, 40.638339061337696],\n",
      "                                [-74.160057540661, 40.63872235274986],\n",
      "                                [-74.15985697767901, 40.63872920221943],\n",
      "                                [-74.15957712397915, 40.63799258321188],\n",
      "                                [-74.15931954037279, 40.63781040574548],\n",
      "                                [-74.15905622378895, 40.6380393103198],\n",
      "                                [-74.1590095788743, 40.638822577909785],\n",
      "                                [-74.1588953235085, 40.6388152771312],\n",
      "                                [-74.15893299160666, 40.63826401781899],\n",
      "                                [-74.15789262953884, 40.637965051231106],\n",
      "                                [-74.15784122272915, 40.638873914966126],\n",
      "                                [-74.1577335257235, 40.638879035165296],\n",
      "                                [-74.15777365937029, 40.63795716024865],\n",
      "                                [-74.15718782782521, 40.6379508052289],\n",
      "                                [-74.1571012669071, 40.63927771860015],\n",
      "                                [-74.15697723294257, 40.63927540119182],\n",
      "                                [-74.15707077305586, 40.637947135640964],\n",
      "                                [-74.1561027649089, 40.63793959088611],\n",
      "                                [-74.1561148826474, 40.637530747164405],\n",
      "                                [-74.15569862053154, 40.63751793890414],\n",
      "                                [-74.15561829326151, 40.63847022002468],\n",
      "                                [-74.15549268934305, 40.63846677952639],\n",
      "                                [-74.15558643758914, 40.63773077586539],\n",
      "                                [-74.15482932461858, 40.63772385541878],\n",
      "                                [-74.15469263864527, 40.63919396811421],\n",
      "                                [-74.15477829011989, 40.63772154555087],\n",
      "                                [-74.15459670163328, 40.63734334406902],\n",
      "                                [-74.1542527007352, 40.63717231088827],\n",
      "                                [-74.15341406597791, 40.63727271907927],\n",
      "                                [-74.15279703511405, 40.63713275485255],\n",
      "                                [-74.15269700449669, 40.63764184172464],\n",
      "                                [-74.15221806884479, 40.637692581716834],\n",
      "                                [-74.15229786175503, 40.63827428826356],\n",
      "                                [-74.15213675899916, 40.63829074795565],\n",
      "                                [-74.15204639233268, 40.63766721531546],\n",
      "                                [-74.1511954500718, 40.637730788536146],\n",
      "                                [-74.1513951761365, 40.63939651305744],\n",
      "                                [-74.15124827966574, 40.63940934288591],\n",
      "                                [-74.15112965090486, 40.638500680073896],\n",
      "                                [-74.15055638842085, 40.63855933066725],\n",
      "                                [-74.14996782090546, 40.63815007524922],\n",
      "                                [-74.14967889830888, 40.637517674260586],\n",
      "                                [-74.1494581822009, 40.637410320847074],\n",
      "                                [-74.14931235597335, 40.63752595814039],\n",
      "                                [-74.14941881708343, 40.63829164054697],\n",
      "                                [-74.1491941815569, 40.63866833137192],\n",
      "                                [-74.14888175543773, 40.63870520797323],\n",
      "                                [-74.14855815092207, 40.63743783752724],\n",
      "                                [-74.14877792005886, 40.638876251127705],\n",
      "                                [-74.1460217310172, 40.63909454970071],\n",
      "                                [-74.14605733618389, 40.63922925768987],\n",
      "                                [-74.14519279481543, 40.63937849765472],\n",
      "                                [-74.1446713323417, 40.639304267726786],\n",
      "                                [-74.14386163595891, 40.63888796251684],\n",
      "                                [-74.14374959918905, 40.638961577750614],\n",
      "                                [-74.14381734530272, 40.63920747892396],\n",
      "                                [-74.1435730859379, 40.6392267852571],\n",
      "                                [-74.14336103010837, 40.63970984518109],\n",
      "                                [-74.14257769336051, 40.63953413750182],\n",
      "                                [-74.14238795149328, 40.6396412108299],\n",
      "                                [-74.14229766980966, 40.640305807093654],\n",
      "                                [-74.14155622972353, 40.640366768817],\n",
      "                                [-74.14148047403451, 40.640092194295455],\n",
      "                                [-74.1407625364528, 40.640589396911196],\n",
      "                                [-74.13757574838483, 40.641001152371125],\n",
      "                                [-74.13734401529298, 40.64114832283011],\n",
      "                                [-74.1373700174998, 40.64129546348895],\n",
      "                                [-74.13435269573633, 40.64188679740515],\n",
      "                                [-74.1343028118537, 40.6417537949093],\n",
      "                                [-74.13349719766673, 40.641716901481104],\n",
      "                                [-74.13341539233282, 40.641547116550996],\n",
      "                                [-74.13299172393486, 40.641416936664605],\n",
      "                                [-74.13240283577126, 40.6417043889845],\n",
      "                                [-74.13125581180259, 40.64159683076382],\n",
      "                                [-74.13146199764819, 40.641310104075046],\n",
      "                                [-74.13018370013212, 40.64072382608305],\n",
      "                                [-74.1296778516623, 40.641385312552885],\n",
      "                                [-74.12949057637368, 40.641354835195834],\n",
      "                                [-74.12997740262726, 40.640729872855594],\n",
      "                                [-74.12930713186852, 40.64033741121097],\n",
      "                                [-74.12922977261063, 40.64048437235239],\n",
      "                                [-74.12893301209903, 40.64041392948784],\n",
      "                                [-74.12890729033454, 40.64119482758614],\n",
      "                                [-74.12881201847131, 40.6402269775039],\n",
      "                                [-74.1275267724088, 40.64015530471647],\n",
      "                                [-74.127147745639, 40.63931105685021],\n",
      "                                [-74.12702736021097, 40.63931907898946],\n",
      "                                [-74.12705362205267, 40.640241737638966],\n",
      "                                [-74.12644823919027, 40.640377994199014],\n",
      "                                [-74.1260698286239, 40.64025447369257],\n",
      "                                [-74.12619996291653, 40.641264314302916],\n",
      "                                [-74.12636808688983, 40.64133238048691],\n",
      "                                [-74.12564026870604, 40.64141849208226],\n",
      "                                [-74.12613276551232, 40.64126438802825],\n",
      "                                [-74.12599542422453, 40.64023124262873],\n",
      "                                [-74.12415578445011, 40.64013471664002],\n",
      "                                [-74.12285630555247, 40.64082050834628],\n",
      "                                [-74.12257280479159, 40.640622340094176],\n",
      "                                [-74.1229072489857, 40.64101926661709],\n",
      "                                [-74.1227620350929, 40.64142663529714],\n",
      "                                [-74.12184146995573, 40.64140589477419],\n",
      "                                [-74.1219908380754, 40.641554639499425],\n",
      "                                [-74.12185329597823, 40.64158069227955],\n",
      "                                [-74.1218066108207, 40.641412159075536],\n",
      "                                [-74.12177911197513, 40.64159254711697],\n",
      "                                [-74.12155886560588, 40.64162163225002],\n",
      "                                [-74.12176052602831, 40.641574315062414],\n",
      "                                [-74.12172375318872, 40.64142866444386],\n",
      "                                [-74.12132617111652, 40.641606569228856],\n",
      "                                [-74.12131194829671, 40.64145253132502],\n",
      "                                [-74.12119488957963, 40.64167501006545],\n",
      "                                [-74.12128074794366, 40.641432495987104],\n",
      "                                [-74.1210772740521, 40.64160742058869],\n",
      "                                [-74.12118039507699, 40.64138344537954],\n",
      "                                [-74.12071317588693, 40.64104578219084],\n",
      "                                [-74.11993480088913, 40.641197604383834],\n",
      "                                [-74.11997111213587, 40.64131481456228],\n",
      "                                [-74.1196071674787, 40.64138030935416],\n",
      "                                [-74.11995699875767, 40.64220945342907],\n",
      "                                [-74.11985443942096, 40.642235613904774],\n",
      "                                [-74.11952986105756, 40.64146991432188],\n",
      "                                [-74.11909720493723, 40.64147346652336],\n",
      "                                [-74.11940029532457, 40.64237937853272],\n",
      "                                [-74.1190034820031, 40.64146461451006],\n",
      "                                [-74.11861635236275, 40.641530365029],\n",
      "                                [-74.11896077402353, 40.6425045159932],\n",
      "                                [-74.11883624616944, 40.642541864060334],\n",
      "                                [-74.11840185083553, 40.64152980054286],\n",
      "                                [-74.11800767093658, 40.6418054975333],\n",
      "                                [-74.1181563574386, 40.642131298298736],\n",
      "                                [-74.11804891156363, 40.6421574610118],\n",
      "                                [-74.11791728683137, 40.64182587695211],\n",
      "                                [-74.11728814480378, 40.641594377204584],\n",
      "                                [-74.11711235699559, 40.64165596713886],\n",
      "                                [-74.1175070252329, 40.642420408430105],\n",
      "                                [-74.1171370640336, 40.6418980646311],\n",
      "                                [-74.11672187663889, 40.64203175609657],\n",
      "                                [-74.11722470082546, 40.64302735996259],\n",
      "                                [-74.1166660764623, 40.64210676633391],\n",
      "                                [-74.11630000082747, 40.64220266510225],\n",
      "                                [-74.1166704138269, 40.64318982489283],\n",
      "                                [-74.11614208635721, 40.64221645415033],\n",
      "                                [-74.11571917042298, 40.64235181921402],\n",
      "                                [-74.11622691905418, 40.643307105862064],\n",
      "                                [-74.11564823433879, 40.642374683334396],\n",
      "                                [-74.11535082182932, 40.64247054015818],\n",
      "                                [-74.1151171475206, 40.64278499267786],\n",
      "                                [-74.1137966608601, 40.64360951580788],\n",
      "                                [-74.11404053146023, 40.64404250211976],\n",
      "                                [-74.11395094068484, 40.64413659167523],\n",
      "                                [-74.11288806510969, 40.644532444637534],\n",
      "                                [-74.11389010824345, 40.643989669126675],\n",
      "                                [-74.11354450863911, 40.643954120067264],\n",
      "                                [-74.1133302319263, 40.64372349758631],\n",
      "                                [-74.11116129469258, 40.64509642318127],\n",
      "                                [-74.11176646650026, 40.644706160344924],\n",
      "                                [-74.10973932564485, 40.64546372818473],\n",
      "                                [-74.10472221599764, 40.64556365739945],\n",
      "                                [-74.10412356301747, 40.6457404322001],\n",
      "                                [-74.1016826444167, 40.6454067329867],\n",
      "                                [-74.10161828954739, 40.64552653887145],\n",
      "                                [-74.10164266441151, 40.64539654892614],\n",
      "                                [-74.10010007356699, 40.64505941609456],\n",
      "                                [-74.09880066885809, 40.64504703431078],\n",
      "                                [-74.09849981625509, 40.645370361953745],\n",
      "                                [-74.09604555281581, 40.64537274744267],\n",
      "                                [-74.09298828187649, 40.64597278075247],\n",
      "                                [-74.09300507296308, 40.646076314816824],\n",
      "                                [-74.09135697942011, 40.646700724100484],\n",
      "                                [-74.08940351561796, 40.6473057766588],\n",
      "                                [-74.08767442681501, 40.648235293614775],\n",
      "                                [-74.08570754378214, 40.648880553370454],\n",
      "                                [-74.08484403215718, 40.648891147339434],\n",
      "                                [-74.08221272914938, 40.64828016229008]]],\n",
      "               'type': 'Polygon'},\n",
      "  'id': 3,\n",
      "  'properties': {'@id': 'http://nyc.pediacities.com/Resource/Borough/Staten_Island',\n",
      "                 'borough': 'Staten Island',\n",
      "                 'boroughCode': 5},\n",
      "  'shape': <shapely.geometry.polygon.Polygon object at 0x7faea5e960b8>,\n",
      "  'type': 'Feature'},\n",
      " {'geometry': {'coordinates': [[[-74.15945602438188, 40.641448333324036],\n",
      "                                [-74.15997875699617, 40.64144648083637],\n",
      "                                [-74.16111242522175, 40.641835453737215],\n",
      "                                [-74.16146036005294, 40.644294969764864],\n",
      "                                [-74.15798759540647, 40.64386178896607],\n",
      "                                [-74.1574334920099, 40.643302857779005],\n",
      "                                [-74.15791589406767, 40.64308269445278],\n",
      "                                [-74.15813451603348, 40.642632530662986],\n",
      "                                [-74.15855043770541, 40.642497501306394],\n",
      "                                [-74.15881093745297, 40.64175863474031],\n",
      "                                [-74.15945602438188, 40.641448333324036]]],\n",
      "               'type': 'Polygon'},\n",
      "  'id': 2,\n",
      "  'properties': {'@id': 'http://nyc.pediacities.com/Resource/Borough/Staten_Island',\n",
      "                 'borough': 'Staten Island',\n",
      "                 'boroughCode': 5},\n",
      "  'shape': <shapely.geometry.polygon.Polygon object at 0x7faea5e965f8>,\n",
      "  'type': 'Feature'},\n",
      " {'geometry': {'coordinates': [[[-74.05314036821109, 40.577702715545755],\n",
      "                                [-74.05406044939875, 40.57711644523887],\n",
      "                                [-74.05489778210804, 40.57778244091981],\n",
      "                                [-74.05469316907487, 40.579691632229434],\n",
      "                                [-74.05485134625391, 40.57970759307761],\n",
      "                                [-74.05484560052174, 40.579945791427605],\n",
      "                                [-74.05368629150419, 40.58054875961441],\n",
      "                                [-74.05293190639817, 40.57990247466585],\n",
      "                                [-74.05314036821109, 40.577702715545755]]],\n",
      "               'type': 'Polygon'},\n",
      "  'id': 1,\n",
      "  'properties': {'@id': 'http://nyc.pediacities.com/Resource/Borough/Staten_Island',\n",
      "                 'borough': 'Staten Island',\n",
      "                 'boroughCode': 5},\n",
      "  'shape': <shapely.geometry.polygon.Polygon object at 0x7faea5e96b70>,\n",
      "  'type': 'Feature'}]\n"
     ]
    }
   ],
   "source": [
    "areaSortedFeatures = sorted(features, key=lambda f: (int(f['properties'][\"boroughCode\"]), f[\"shape\"].area), reverse=True)\n",
    "see(\"areaSortedFeatures\", areaSortedFeatures[0:3])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [],
   "source": [
    "bFeatures = sc.broadcast(areaSortedFeatures)\n",
    "# Access the broadcast variable value through value.\n",
    "bFeaturesValue = bFeatures.value"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'list'>\n",
      "<class 'pyspark.broadcast.Broadcast'>\n",
      "<class 'list'>\n"
     ]
    }
   ],
   "source": [
    "print(type(areaSortedFeatures)) \n",
    "print(type(bFeatures))\n",
    "print(type(bFeatures.value))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Working with Third-Party Libraries in Spark\n",
    "- Convert Longitude and latitude to a zone depending on UDF\n",
    "- We are going to use shapely library written in python\n",
    "- For better performance you should use a java alternative (Read Advanced anlytics with spark book starting page 172) <b> and this is a bonus assignment: convert the following UDF to the java version </b>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "One strategy that experienced data scientists deploy when working with a new data set is to add a try-catch block to their parsing code so that any invalid records can be written out to the logs without causing the entire job to fail. If there are only a handful of invalid records in the entire data set, we might be okay with ignoring them and continuing with our analysis. With Spark, we can do even better: we can adapt our parsing code so that we can interactively analyze the invalid records in our data just as easily as we would perform any other kind of analysis."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {},
   "outputs": [],
   "source": [
    "#Convert longitude and latitude to point(shapely point)\n",
    "def locArea(long,latit):\n",
    "    try:\n",
    "        pointLocation = Point(float(long), float(latit))\n",
    "    except ValueError:\n",
    "        pointLocation = Point(0.0, 0.0)\n",
    "    return pointLocation\n",
    "\n",
    "#check and convert point to borough\n",
    "def borough(long,latit,areaSortedFeatures):\n",
    "    for f in areaSortedFeatures:\n",
    "        #contains checks if the \n",
    "        if f['shape'].contains(locArea(long,latit)):\n",
    "            return str(f['properties'][\"borough\"])\n",
    "    return None\n",
    "\n",
    "def toPoint(x,y):\n",
    "    return Point(float(x), float(y))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>hack_license</th>\n",
       "      <th>dropoff_longitude</th>\n",
       "      <th>dropoff_latitude</th>\n",
       "      <th>dropoff_datetime</th>\n",
       "      <th>pickup_longitude</th>\n",
       "      <th>pickup_latitude</th>\n",
       "      <th>pickup_datetime</th>\n",
       "      <th>pickupArea</th>\n",
       "      <th>dropoffArea</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>BA96DE419E711691B9445D6A6307C170</td>\n",
       "      <td>-73.989838</td>\n",
       "      <td>40.751171</td>\n",
       "      <td>2013-01-01 15:18:10</td>\n",
       "      <td>-73.978165</td>\n",
       "      <td>40.757977</td>\n",
       "      <td>2013-01-01 15:11:48</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>Manhattan</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>-73.994499</td>\n",
       "      <td>40.75066</td>\n",
       "      <td>2013-01-06 00:22:54</td>\n",
       "      <td>-74.006683</td>\n",
       "      <td>40.731781</td>\n",
       "      <td>2013-01-06 00:18:35</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>Manhattan</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>-74.009834</td>\n",
       "      <td>40.726002</td>\n",
       "      <td>2013-01-05 18:54:23</td>\n",
       "      <td>-74.004707</td>\n",
       "      <td>40.73777</td>\n",
       "      <td>2013-01-05 18:49:41</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>Manhattan</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                       hack_license dropoff_longitude dropoff_latitude  \\\n",
       "0  BA96DE419E711691B9445D6A6307C170        -73.989838        40.751171   \n",
       "1  9FD8F69F0804BDB5549F40E9DA1BE472        -73.994499         40.75066   \n",
       "2  9FD8F69F0804BDB5549F40E9DA1BE472        -74.009834        40.726002   \n",
       "\n",
       "      dropoff_datetime pickup_longitude pickup_latitude      pickup_datetime  \\\n",
       "0  2013-01-01 15:18:10       -73.978165       40.757977  2013-01-01 15:11:48   \n",
       "1  2013-01-06 00:22:54       -74.006683       40.731781  2013-01-06 00:18:35   \n",
       "2  2013-01-05 18:54:23       -74.004707        40.73777  2013-01-05 18:49:41   \n",
       "\n",
       "  pickupArea dropoffArea  \n",
       "0  Manhattan   Manhattan  \n",
       "1  Manhattan   Manhattan  \n",
       "2  Manhattan   Manhattan  "
      ]
     },
     "execution_count": 19,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "pickup = udf(lambda long,latit :  borough(long,latit,bFeaturesValue) , StringType())\n",
    "taxiParsed=taxi.withColumn(\"pickupArea\" ,pickup(\"pickup_longitude\",\"pickup_latitude\")).withColumn(\"dropoffArea\" ,pickup(\"dropoff_longitude\",\"dropoff_latitude\"))\n",
    "taxiParsed.limit(3).toPandas()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#   Explore the distribution of trip duration (hours)\n",
    "Given the temporal nature of our trip data, one reasonable invariant that we can expect is that the dropoff time for any trip will be sometime after the pickup time. We might also expect that trips will not take more than a few hours to complete, although it’s certainly possible that long trips, trips that take place during rush hour, or trips that are delayed by accidents could go on for several hours. We’re not exactly sure what the cutoff should be for a trip that takes a “reasonable” amount of time.let's explore"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {},
   "outputs": [],
   "source": [
    "#unix_timeStamp: Convert time string with given pattern (‘yyyy-MM-dd HH:mm:ss’, by default) \n",
    "#to Unix time stamp (in seconds),\n",
    "#using the default timezone and the default locale, return null if fail.\n",
    "taxiWithTS = taxiParsed.withColumn('pickupTime',unix_timestamp(to_timestamp(col('pickup_datetime'))))\n",
    "taxiWithTS = taxiWithTS.withColumn('dropoffTime',unix_timestamp(to_timestamp(col('dropoff_datetime'))))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {},
   "outputs": [],
   "source": [
    "taxiParsedSelected=taxiWithTS.select(\"hack_license\",\"pickupArea\",\"pickupTime\",\"dropoffArea\",\"dropoffTime\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "root\n",
      " |-- hack_license: string (nullable = true)\n",
      " |-- pickupArea: string (nullable = true)\n",
      " |-- pickupTime: long (nullable = true)\n",
      " |-- dropoffArea: string (nullable = true)\n",
      " |-- dropoffTime: long (nullable = true)\n",
      "\n"
     ]
    }
   ],
   "source": [
    "taxiParsedSelected.printSchema()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+--------------------+----------+----------+-----------+-----------+\n",
      "|        hack_license|pickupArea|pickupTime|dropoffArea|dropoffTime|\n",
      "+--------------------+----------+----------+-----------+-----------+\n",
      "|BA96DE419E711691B...| Manhattan|1357053108|  Manhattan| 1357053490|\n",
      "|9FD8F69F0804BDB55...| Manhattan|1357431515|  Manhattan| 1357431774|\n",
      "|9FD8F69F0804BDB55...| Manhattan|1357411781|  Manhattan| 1357412063|\n",
      "+--------------------+----------+----------+-----------+-----------+\n",
      "only showing top 3 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "taxiParsedSelected.show(3)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+--------------------+----------+----------+-----------+-----------+----+\n",
      "|        hack_license|pickupArea|pickupTime|dropoffArea|dropoffTime|hour|\n",
      "+--------------------+----------+----------+-----------+-----------+----+\n",
      "|BA96DE419E711691B...| Manhattan|1357053108|  Manhattan| 1357053490| 0.0|\n",
      "|9FD8F69F0804BDB55...| Manhattan|1357431515|  Manhattan| 1357431774| 0.0|\n",
      "|9FD8F69F0804BDB55...| Manhattan|1357411781|  Manhattan| 1357412063| 0.0|\n",
      "+--------------------+----------+----------+-----------+-----------+----+\n",
      "only showing top 3 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "#diff = unix_timestamp(to_timestamp(col('dropoff_datetime')))-unix_timestamp(to_timestamp(col('pickup_datetime')))\n",
    "diff = col('dropoffTime')-col('pickupTime')\n",
    "taxiWithHour = taxiParsedSelected.withColumn(\"hour\",(round(diff/3600)))\n",
    "taxiWithHour.show(3)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+----+-----+\n",
      "|hour|count|\n",
      "+----+-----+\n",
      "| 0.0|96615|\n",
      "| 1.0| 3378|\n",
      "| 3.0|    1|\n",
      "| 2.0|    5|\n",
      "+----+-----+\n",
      "\n"
     ]
    }
   ],
   "source": [
    "taxiWithHour.groupBy(\"hour\").count().show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#  Remove trips with -ve durations and longer than 3 hours"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>hack_license</th>\n",
       "      <th>pickupArea</th>\n",
       "      <th>pickupTime</th>\n",
       "      <th>dropoffArea</th>\n",
       "      <th>dropoffTime</th>\n",
       "      <th>hour</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>BA96DE419E711691B9445D6A6307C170</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1357053108</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1357053490</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1357431515</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1357431774</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>9FD8F69F0804BDB5549F40E9DA1BE472</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1357411781</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1357412063</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                       hack_license pickupArea  pickupTime dropoffArea  \\\n",
       "0  BA96DE419E711691B9445D6A6307C170  Manhattan  1357053108   Manhattan   \n",
       "1  9FD8F69F0804BDB5549F40E9DA1BE472  Manhattan  1357431515   Manhattan   \n",
       "2  9FD8F69F0804BDB5549F40E9DA1BE472  Manhattan  1357411781   Manhattan   \n",
       "\n",
       "   dropoffTime  hour  \n",
       "0   1357053490   0.0  \n",
       "1   1357431774   0.0  \n",
       "2   1357412063   0.0  "
      ]
     },
     "execution_count": 26,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#Cache as we are going to use it many times\n",
    "taxiClean=taxiWithHour.filter(\"hour >= 0 and hour <3\").cache()\n",
    "taxiClean.limit(3).toPandas()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-------------+-----+\n",
      "|  dropoffArea|count|\n",
      "+-------------+-----+\n",
      "|    Manhattan|88163|\n",
      "|       Queens| 5475|\n",
      "|     Brooklyn| 3595|\n",
      "|         null| 2357|\n",
      "|        Bronx|  395|\n",
      "|Staten Island|   13|\n",
      "+-------------+-----+\n",
      "\n"
     ]
    }
   ],
   "source": [
    "boroughCount=taxiClean.groupBy('dropoffArea').count().orderBy('count' , ascending=False)\n",
    "boroughCount.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Sessionize trips\n",
    "\n",
    "- Look at sorted list of trips for each driver\n",
    "- Once the difference between any 2 consecurtive trips is longer than 4 hours, we consider that a new session has started\n",
    "- Our goal, from many pages ago, was to investigate the relationship between the bor‐ ough in which a driver drops his passenger off and the amount of time it takes to acquire another fare. At this point, the taxiDone data set contains all of the individual trips for each taxi driver in individual records distributed across different partitions of the data. To compute the length of time between the end of one ride and the start of the next one, we need to aggregate all of the trips from a shift by a single driver into a single record, and then sort the trips within that shift by time. The sort step allows us to compare the dropoff time of one trip to the pickup time of the next trip. This kind of analysis, in which we want to analyze a single entity as it executes a series of events over time, is called sessionization, and is commonly performed over web logs to analyze the behavior of the users of a website.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>hack_license</th>\n",
       "      <th>pickupArea</th>\n",
       "      <th>pickupTime</th>\n",
       "      <th>dropoffArea</th>\n",
       "      <th>dropoffTime</th>\n",
       "      <th>hour</th>\n",
       "      <th>diff</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>02856AFC22881ABCADDD5284BADDEB8D</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358044920</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358045460</td>\n",
       "      <td>0.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>02856AFC22881ABCADDD5284BADDEB8D</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358047920</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358048460</td>\n",
       "      <td>0.0</td>\n",
       "      <td>2460.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>02856AFC22881ABCADDD5284BADDEB8D</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358048640</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358049420</td>\n",
       "      <td>0.0</td>\n",
       "      <td>180.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358063700</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358064000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358069580</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358069760</td>\n",
       "      <td>0.0</td>\n",
       "      <td>5580.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358070420</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358071320</td>\n",
       "      <td>0.0</td>\n",
       "      <td>660.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358075340</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358076000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>4020.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358076120</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358076300</td>\n",
       "      <td>0.0</td>\n",
       "      <td>120.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358076900</td>\n",
       "      <td>Queens</td>\n",
       "      <td>1358079120</td>\n",
       "      <td>1.0</td>\n",
       "      <td>600.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Queens</td>\n",
       "      <td>1358085060</td>\n",
       "      <td>Queens</td>\n",
       "      <td>1358085840</td>\n",
       "      <td>0.0</td>\n",
       "      <td>5940.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>03A2D28F831C5C3E590F9E4A511BD3B1</td>\n",
       "      <td>Queens</td>\n",
       "      <td>1358087940</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358089620</td>\n",
       "      <td>0.0</td>\n",
       "      <td>2100.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>069B5562096AF76848A613F23073B4BA</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358043240</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358043840</td>\n",
       "      <td>0.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>Queens</td>\n",
       "      <td>1358072340</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358073840</td>\n",
       "      <td>0.0</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358073960</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358074440</td>\n",
       "      <td>0.0</td>\n",
       "      <td>120.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358079900</td>\n",
       "      <td>Queens</td>\n",
       "      <td>1358081220</td>\n",
       "      <td>0.0</td>\n",
       "      <td>5460.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>15</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>Queens</td>\n",
       "      <td>1358086740</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358088240</td>\n",
       "      <td>0.0</td>\n",
       "      <td>5520.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358088840</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358089500</td>\n",
       "      <td>0.0</td>\n",
       "      <td>600.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>17</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>None</td>\n",
       "      <td>1358094540</td>\n",
       "      <td>None</td>\n",
       "      <td>1358095080</td>\n",
       "      <td>0.0</td>\n",
       "      <td>5040.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>18</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>None</td>\n",
       "      <td>1358095200</td>\n",
       "      <td>None</td>\n",
       "      <td>1358095920</td>\n",
       "      <td>0.0</td>\n",
       "      <td>120.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>19</th>\n",
       "      <td>0FBF11956EE14B253F7FEA8160C31CDB</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358098020</td>\n",
       "      <td>Manhattan</td>\n",
       "      <td>1358098500</td>\n",
       "      <td>0.0</td>\n",
       "      <td>2100.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                        hack_license pickupArea  pickupTime dropoffArea  \\\n",
       "0   02856AFC22881ABCADDD5284BADDEB8D  Manhattan  1358044920   Manhattan   \n",
       "1   02856AFC22881ABCADDD5284BADDEB8D  Manhattan  1358047920   Manhattan   \n",
       "2   02856AFC22881ABCADDD5284BADDEB8D  Manhattan  1358048640   Manhattan   \n",
       "3   03A2D28F831C5C3E590F9E4A511BD3B1  Manhattan  1358063700   Manhattan   \n",
       "4   03A2D28F831C5C3E590F9E4A511BD3B1  Manhattan  1358069580   Manhattan   \n",
       "5   03A2D28F831C5C3E590F9E4A511BD3B1  Manhattan  1358070420   Manhattan   \n",
       "6   03A2D28F831C5C3E590F9E4A511BD3B1  Manhattan  1358075340   Manhattan   \n",
       "7   03A2D28F831C5C3E590F9E4A511BD3B1  Manhattan  1358076120   Manhattan   \n",
       "8   03A2D28F831C5C3E590F9E4A511BD3B1  Manhattan  1358076900      Queens   \n",
       "9   03A2D28F831C5C3E590F9E4A511BD3B1     Queens  1358085060      Queens   \n",
       "10  03A2D28F831C5C3E590F9E4A511BD3B1     Queens  1358087940   Manhattan   \n",
       "11  069B5562096AF76848A613F23073B4BA  Manhattan  1358043240   Manhattan   \n",
       "12  0FBF11956EE14B253F7FEA8160C31CDB     Queens  1358072340   Manhattan   \n",
       "13  0FBF11956EE14B253F7FEA8160C31CDB  Manhattan  1358073960   Manhattan   \n",
       "14  0FBF11956EE14B253F7FEA8160C31CDB  Manhattan  1358079900      Queens   \n",
       "15  0FBF11956EE14B253F7FEA8160C31CDB     Queens  1358086740   Manhattan   \n",
       "16  0FBF11956EE14B253F7FEA8160C31CDB  Manhattan  1358088840   Manhattan   \n",
       "17  0FBF11956EE14B253F7FEA8160C31CDB       None  1358094540        None   \n",
       "18  0FBF11956EE14B253F7FEA8160C31CDB       None  1358095200        None   \n",
       "19  0FBF11956EE14B253F7FEA8160C31CDB  Manhattan  1358098020   Manhattan   \n",
       "\n",
       "    dropoffTime  hour    diff  \n",
       "0    1358045460   0.0     NaN  \n",
       "1    1358048460   0.0  2460.0  \n",
       "2    1358049420   0.0   180.0  \n",
       "3    1358064000   0.0     NaN  \n",
       "4    1358069760   0.0  5580.0  \n",
       "5    1358071320   0.0   660.0  \n",
       "6    1358076000   0.0  4020.0  \n",
       "7    1358076300   0.0   120.0  \n",
       "8    1358079120   1.0   600.0  \n",
       "9    1358085840   0.0  5940.0  \n",
       "10   1358089620   0.0  2100.0  \n",
       "11   1358043840   0.0     NaN  \n",
       "12   1358073840   0.0     NaN  \n",
       "13   1358074440   0.0   120.0  \n",
       "14   1358081220   0.0  5460.0  \n",
       "15   1358088240   0.0  5520.0  \n",
       "16   1358089500   0.0   600.0  \n",
       "17   1358095080   0.0  5040.0  \n",
       "18   1358095920   0.0   120.0  \n",
       "19   1358098500   0.0  2100.0  "
      ]
     },
     "execution_count": 28,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#calculating the difference between the pickup time and the previous dropoff loc and put it in another column\n",
    "from pyspark.sql.functions import col, lag\n",
    "from pyspark.sql.window import Window\n",
    "\n",
    "#partition by driver to make sure to order the trips done by the same driver\n",
    "w = Window.partitionBy(\"hack_license\").orderBy(\"pickupTime\")\n",
    "\n",
    "diff = col(\"pickupTime\") - lag(\"dropoffTime\", 1).over(w)\n",
    "\n",
    "taxiCleanwithdifferenceTime=taxiClean.withColumn(\"diff\", diff)\n",
    "taxiCleanwithdifferenceTime.limit(20).toPandas()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+--------------------+----------+----------+-----------+-----------+----+----+\n",
      "|        hack_license|pickupArea|pickupTime|dropoffArea|dropoffTime|hour|diff|\n",
      "+--------------------+----------+----------+-----------+-----------+----+----+\n",
      "|02856AFC22881ABCA...| Manhattan|1358044920|  Manhattan| 1358045460| 0.0|   0|\n",
      "|02856AFC22881ABCA...| Manhattan|1358047920|  Manhattan| 1358048460| 0.0|2460|\n",
      "|02856AFC22881ABCA...| Manhattan|1358048640|  Manhattan| 1358049420| 0.0| 180|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358063700|  Manhattan| 1358064000| 0.0|   0|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358069580|  Manhattan| 1358069760| 0.0|5580|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358070420|  Manhattan| 1358071320| 0.0| 660|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358075340|  Manhattan| 1358076000| 0.0|4020|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358076120|  Manhattan| 1358076300| 0.0| 120|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358076900|     Queens| 1358079120| 1.0| 600|\n",
      "|03A2D28F831C5C3E5...|    Queens|1358085060|     Queens| 1358085840| 0.0|5940|\n",
      "+--------------------+----------+----------+-----------+-----------+----+----+\n",
      "only showing top 10 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "taxiCleanwithdifferenceTimewithouNulls=taxiCleanwithdifferenceTime.na.fill({\"diff\" : 0.0})\n",
    "taxiCleanwithdifferenceTimewithouNulls.show(10)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+--------------------+----------+----------+-----------+-----------+----+----+--------+\n",
      "|        hack_license|pickupArea|pickupTime|dropoffArea|dropoffTime|hour|diff|idleTime|\n",
      "+--------------------+----------+----------+-----------+-----------+----+----+--------+\n",
      "|02856AFC22881ABCA...| Manhattan|1358044920|  Manhattan| 1358045460| 0.0|   0|       0|\n",
      "|02856AFC22881ABCA...| Manhattan|1358047920|  Manhattan| 1358048460| 0.0|2460|    2460|\n",
      "|02856AFC22881ABCA...| Manhattan|1358048640|  Manhattan| 1358049420| 0.0| 180|     180|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358063700|  Manhattan| 1358064000| 0.0|   0|       0|\n",
      "|03A2D28F831C5C3E5...| Manhattan|1358069580|  Manhattan| 1358069760| 0.0|5580|    5580|\n",
      "+--------------------+----------+----------+-----------+-----------+----+----+--------+\n",
      "only showing top 5 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "#4 hrs = 14400.0 sec \n",
    "TaxiIdleTime = taxiCleanwithdifferenceTimewithouNulls.withColumn(\"idleTime\",when(col(\"diff\")>=14400,0).otherwise(col(\"diff\")))\n",
    "TaxiIdleTime.show(5)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-------------+------------------+\n",
      "|  dropoffArea|     avg(idleTime)|\n",
      "+-------------+------------------+\n",
      "|Staten Island|             240.0|\n",
      "|    Manhattan| 869.9117997345826|\n",
      "|     Brooklyn|1118.8603616133519|\n",
      "|        Bronx|1148.3544303797469|\n",
      "|         null|1248.9681798896902|\n",
      "|       Queens|1351.7227397260274|\n",
      "+-------------+------------------+\n",
      "\n"
     ]
    }
   ],
   "source": [
    "#it is clear that staten island and manhattan have least idle time\n",
    "TaxiIdleTime.groupBy(\"dropoffArea\").avg(\"idleTime\").orderBy(\"avg(idleTime)\").show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
